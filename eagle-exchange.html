<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Eagle Exchange â€” UK Load Board Simulator | Eagle Academy</title>
<link rel="stylesheet" href="assets/style.css"/>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Sans:wght@300;400;500;600&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet"/>
<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   EAGLE EXCHANGE â€” UK Load Board Simulator
   Light classroom theme, Eagle Academy branding
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
:root {
  --navy:    #2B2BA8;
  --navy2:   #1e1e8f;
  --navy3:   #16166a;
  --orange:  #F47920;
  --orange2: #f79240;
  --og-dk:   #d4661a;
  --bg:      #f0f2f8;
  --surface: #ffffff;
  --surf2:   #f8f9ff;
  --text:    #1a1a5e;
  --text2:   #4a4a8a;
  --text3:   #8888aa;
  --border:  rgba(43,43,168,0.14);
  --green:   #16a34a;
  --green-bg:rgba(22,163,74,0.10);
  --red:     #dc2626;
  --red-bg:  rgba(220,38,38,0.10);
  --amber:   #d97706;
  --amber-bg:rgba(217,119,6,0.10);
  --sh-sm:   0 2px 8px rgba(43,43,168,0.08);
  --sh:      0 4px 20px rgba(43,43,168,0.12);
  --sh-lg:   0 8px 40px rgba(43,43,168,0.18);
  --r:       12px;
  --r-sm:    8px;
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html,body{background:var(--bg);color:var(--text);font-family:'DM Sans',sans-serif;font-size:15px;line-height:1.5;min-height:100vh}

/* HEADER */
.ex-header{background:var(--navy);border-bottom:3px solid var(--orange);position:sticky;top:0;z-index:300;box-shadow:0 2px 16px rgba(43,43,168,0.3)}
.ex-header-inner{max-width:1400px;margin:0 auto;padding:0 20px;height:62px;display:flex;align-items:center;gap:16px}
.ex-logo{display:flex;align-items:center;gap:10px;text-decoration:none;flex-shrink:0}
.ex-logo-icon{width:38px;height:38px;background:linear-gradient(135deg,var(--orange),var(--og-dk));border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:20px}
.ex-logo-text{line-height:1}
.ex-logo-text .name{font-family:'Syne',sans-serif;font-weight:800;font-size:16px;color:#fff;letter-spacing:.5px}
.ex-logo-text .sub{font-size:9px;color:var(--orange);letter-spacing:2px;text-transform:uppercase}
.ex-badge{background:rgba(244,121,32,0.2);border:1px solid rgba(244,121,32,0.4);color:var(--orange);font-size:10px;font-weight:700;padding:3px 8px;border-radius:20px;letter-spacing:.5px}
.ex-nav-back{margin-left:auto;display:flex;align-items:center;gap:10px}
.ex-nav-back a{color:rgba(255,255,255,0.75);font-size:12px;font-weight:600;text-decoration:none;padding:6px 12px;border-radius:var(--r-sm);border:1px solid rgba(255,255,255,0.2);transition:all .2s}
.ex-nav-back a:hover{color:#fff;background:rgba(255,255,255,0.1)}
.live-clock{font-family:'JetBrains Mono',monospace;font-size:11px;color:rgba(255,255,255,0.8);background:rgba(255,255,255,0.08);padding:5px 10px;border-radius:6px;border:1px solid rgba(255,255,255,0.15)}
.live-clock .uk-label{color:var(--orange);font-weight:700}

/* TICKER */
.ex-ticker{background:var(--navy3);border-bottom:1px solid rgba(244,121,32,0.2);overflow:hidden;white-space:nowrap;padding:7px 0}
.ex-ticker-inner{display:inline-block;animation:ticker 45s linear infinite}
.ex-ticker span{display:inline-block;padding:0 24px;font-size:11px;font-weight:600;color:rgba(255,255,255,0.85)}
.ex-ticker .dot{color:var(--orange)}
@keyframes ticker{0%{transform:translateX(0)}100%{transform:translateX(-50%)}}

/* LAYOUT */
.ex-wrap{max-width:1400px;margin:0 auto;padding:20px;display:grid;grid-template-columns:1fr 420px;gap:20px;align-items:start}
@media(max-width:1100px){.ex-wrap{grid-template-columns:1fr}}

/* STATS BAR */
.stats-bar{grid-column:1/-1;display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:4px}
.stat-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--r);padding:14px 18px;display:flex;align-items:center;gap:12px;box-shadow:var(--sh-sm)}
.stat-icon{width:40px;height:40px;border-radius:var(--r-sm);display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0}
.stat-val{font-family:'Syne',sans-serif;font-size:22px;font-weight:800;color:var(--navy);line-height:1}
.stat-lbl{font-size:11px;color:var(--text3);font-weight:600;text-transform:uppercase;letter-spacing:.4px;margin-top:2px}

/* LEFT â€” LOAD BOARD */
.board-panel{background:var(--surface);border:1px solid var(--border);border-radius:var(--r);box-shadow:var(--sh-sm);overflow:hidden}
.board-header{background:linear-gradient(135deg,var(--navy),var(--navy2));padding:16px 20px;display:flex;align-items:center;justify-content:space-between;gap:12px}
.board-title{font-family:'Syne',sans-serif;font-weight:800;font-size:16px;color:#fff}
.board-subtitle{font-size:11px;color:rgba(255,255,255,0.7);margin-top:2px}
.board-refresh{background:rgba(255,255,255,0.12);border:1px solid rgba(255,255,255,0.2);color:#fff;padding:6px 12px;border-radius:var(--r-sm);font-size:11px;font-weight:700;cursor:pointer;transition:all .2s;font-family:'DM Sans',sans-serif}
.board-refresh:hover{background:rgba(244,121,32,0.3);border-color:var(--orange)}

/* FILTERS */
.board-filters{padding:12px 16px;background:var(--surf2);border-bottom:1px solid var(--border);display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.filter-select{background:#fff;border:1px solid var(--border);border-radius:var(--r-sm);padding:6px 10px;font-size:12px;font-weight:600;color:var(--text);cursor:pointer;font-family:'DM Sans',sans-serif;outline:none}
.filter-select:focus{border-color:var(--navy)}
.filter-search{flex:1;min-width:120px;background:#fff;border:1px solid var(--border);border-radius:var(--r-sm);padding:6px 12px;font-size:12px;color:var(--text);font-family:'DM Sans',sans-serif;outline:none}
.filter-search:focus{border-color:var(--navy)}
.filter-count{margin-left:auto;font-size:11px;font-weight:700;color:var(--text3)}

/* LOAD LIST */
.load-list{max-height:580px;overflow-y:auto;scrollbar-width:thin;scrollbar-color:var(--navy) var(--surf2)}
.load-list::-webkit-scrollbar{width:4px}
.load-list::-webkit-scrollbar-thumb{background:var(--navy);border-radius:2px}
.load-item{padding:14px 16px;border-bottom:1px solid var(--border);cursor:pointer;transition:all .18s;position:relative}
.load-item:hover{background:rgba(43,43,168,0.04)}
.load-item.selected{background:rgba(244,121,32,0.06);border-left:3px solid var(--orange)}
.load-item.booked{opacity:0.5;cursor:not-allowed}
.load-item.urgent::before{content:'URGENT';position:absolute;top:12px;right:12px;background:var(--red);color:#fff;font-size:9px;font-weight:800;padding:2px 6px;border-radius:4px;letter-spacing:.5px;animation:urgentPulse 1.5s ease-in-out infinite}
@keyframes urgentPulse{0%,100%{opacity:1}50%{opacity:0.6}}
.load-route{display:flex;align-items:center;gap:8px;margin-bottom:6px}
.load-city{font-family:'Syne',sans-serif;font-weight:700;font-size:14px;color:var(--navy)}
.load-arrow{color:var(--orange);font-size:14px}
.load-meta{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px}
.load-tag{font-size:10px;font-weight:700;padding:2px 7px;border-radius:10px;letter-spacing:.3px}
.lt-vehicle{background:rgba(43,43,168,0.08);color:var(--navy)}
.lt-weight{background:rgba(244,121,32,0.08);color:#c45e10}
.lt-distance{background:rgba(8,145,178,0.08);color:#0891b2}
.lt-collection{background:rgba(22,163,74,0.08);color:var(--green)}
.load-bottom{display:flex;align-items:center;justify-content:space-between}
.load-rate{font-family:'Syne',sans-serif;font-weight:800;font-size:18px;color:var(--navy)}
.load-cpm{font-size:11px;color:var(--text3);margin-top:1px}
.load-broker{display:flex;align-items:center;gap:6px}
.broker-name{font-size:11px;font-weight:600;color:var(--text2)}
.cx-score{font-size:10px;font-weight:800;padding:2px 6px;border-radius:6px}
.cx-green{background:var(--green-bg);color:var(--green)}
.cx-amber{background:var(--amber-bg);color:var(--amber)}
.cx-red{background:var(--red-bg);color:var(--red)}
.load-booked-badge{position:absolute;top:14px;right:12px;background:var(--green-bg);color:var(--green);font-size:10px;font-weight:800;padding:3px 8px;border-radius:6px}

/* RIGHT â€” DETAIL PANEL */
.detail-panel{background:var(--surface);border:1px solid var(--border);border-radius:var(--r);box-shadow:var(--sh-sm);position:sticky;top:82px}
.detail-empty{padding:60px 20px;text-align:center;color:var(--text3)}
.detail-empty .big-icon{font-size:48px;margin-bottom:12px}
.detail-empty p{font-size:13px;line-height:1.6}
.detail-header{background:linear-gradient(135deg,var(--navy),var(--navy2));padding:18px 20px;border-radius:var(--r) var(--r) 0 0}
.detail-route{display:flex;align-items:center;gap:10px;margin-bottom:8px}
.detail-city{font-family:'Syne',sans-serif;font-weight:800;font-size:18px;color:#fff}
.detail-arrow{color:var(--orange);font-size:20px}
.detail-rate-big{font-family:'Syne',sans-serif;font-size:32px;font-weight:800;color:#fff;line-height:1}
.detail-cpm-big{font-size:12px;color:rgba(255,255,255,0.7);margin-top:2px}
.detail-urgency{display:inline-block;background:var(--red);color:#fff;font-size:10px;font-weight:800;padding:3px 8px;border-radius:4px;margin-top:8px;animation:urgentPulse 1.5s ease-in-out infinite}
.detail-body{padding:18px 20px}
.detail-section{margin-bottom:16px}
.detail-section-title{font-size:10px;font-weight:800;text-transform:uppercase;letter-spacing:.8px;color:var(--text3);margin-bottom:8px}
.detail-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.detail-field{background:var(--surf2);border:1px solid var(--border);border-radius:var(--r-sm);padding:10px 12px}
.detail-field-label{font-size:10px;color:var(--text3);font-weight:600;text-transform:uppercase;letter-spacing:.4px}
.detail-field-value{font-size:13px;font-weight:700;color:var(--text);margin-top:2px}
.broker-card{background:var(--surf2);border:1px solid var(--border);border-radius:var(--r-sm);padding:12px;display:flex;align-items:center;justify-content:space-between}
.broker-info .bname{font-weight:700;font-size:13px;color:var(--text)}
.broker-info .bloc{font-size:11px;color:var(--text3)}
.cx-score-big{font-size:16px;font-weight:800;padding:4px 10px;border-radius:8px}
.broker-warning{background:var(--red-bg);border:1px solid rgba(220,38,38,0.2);border-radius:var(--r-sm);padding:10px 12px;font-size:12px;color:var(--red);font-weight:600;margin-top:8px}
.broker-good{background:var(--green-bg);border:1px solid rgba(22,163,74,0.2);border-radius:var(--r-sm);padding:10px 12px;font-size:12px;color:var(--green);font-weight:600;margin-top:8px}

/* NEGOTIATION */
.nego-panel{border-top:2px solid var(--border);padding:16px 20px;background:var(--surf2)}
.nego-title{font-family:'Syne',sans-serif;font-weight:800;font-size:13px;color:var(--navy);margin-bottom:4px}
.nego-sub{font-size:11px;color:var(--text3);margin-bottom:12px}
.nego-offer{background:#fff;border:1px solid var(--border);border-radius:var(--r-sm);padding:12px;margin-bottom:10px}
.nego-offer-label{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--text3);margin-bottom:4px}
.nego-offer-amount{font-family:'Syne',sans-serif;font-size:22px;font-weight:800;color:var(--navy)}
.nego-input-row{display:flex;gap:8px;margin-bottom:8px}
.nego-input{flex:1;background:#fff;border:2px solid var(--border);border-radius:var(--r-sm);padding:10px 12px;font-size:15px;font-weight:700;color:var(--navy);font-family:'JetBrains Mono',monospace;outline:none}
.nego-input:focus{border-color:var(--orange)}
.nego-btn{background:linear-gradient(135deg,var(--orange),var(--og-dk));color:#fff;border:none;border-radius:var(--r-sm);padding:10px 16px;font-size:13px;font-weight:700;cursor:pointer;font-family:'DM Sans',sans-serif;white-space:nowrap;transition:all .2s}
.nego-btn:hover{filter:brightness(1.08);transform:translateY(-1px)}
.nego-btn:disabled{opacity:0.5;cursor:not-allowed;transform:none}
.nego-rounds{font-size:11px;color:var(--text3);text-align:center;margin-bottom:10px}
.nego-history{max-height:140px;overflow-y:auto;display:flex;flex-direction:column;gap:6px;margin-bottom:10px}
.nego-msg{padding:8px 12px;border-radius:var(--r-sm);font-size:12px;font-weight:600;line-height:1.4}
.nego-msg.dispatcher{background:rgba(43,43,168,0.08);color:var(--navy);text-align:right}
.nego-msg.broker{background:rgba(244,121,32,0.08);color:#c45e10;border-left:3px solid var(--orange)}
.nego-msg.system{background:var(--surf2);color:var(--text3);text-align:center;font-style:italic}
.nego-result{padding:12px;border-radius:var(--r-sm);font-size:13px;font-weight:700;margin-bottom:10px;text-align:center}
.nego-result.win{background:var(--green-bg);color:var(--green);border:1px solid rgba(22,163,74,0.3)}
.nego-result.lose{background:var(--red-bg);color:var(--red);border:1px solid rgba(220,38,38,0.3)}
.nego-result.partial{background:var(--amber-bg);color:var(--amber);border:1px solid rgba(217,119,6,0.3)}
.book-btn{width:100%;background:linear-gradient(135deg,var(--green),#15803d);color:#fff;border:none;border-radius:var(--r-sm);padding:13px;font-size:14px;font-weight:800;cursor:pointer;font-family:'Syne',sans-serif;letter-spacing:.3px;transition:all .2s;display:none}
.book-btn:hover{filter:brightness(1.08);transform:translateY(-1px)}
.book-btn.show{display:block}

/* BOOKING MODAL */
.modal-overlay{position:fixed;inset:0;background:rgba(26,26,94,0.5);backdrop-filter:blur(4px);z-index:500;display:none;align-items:center;justify-content:center;padding:20px}
.modal-overlay.show{display:flex}
.modal{background:var(--surface);border-radius:16px;width:100%;max-width:560px;max-height:90vh;overflow-y:auto;box-shadow:var(--sh-lg)}
.modal-header{background:linear-gradient(135deg,var(--navy),var(--navy2));padding:20px 24px;border-radius:16px 16px 0 0;display:flex;align-items:center;justify-content:space-between}
.modal-title{font-family:'Syne',sans-serif;font-weight:800;font-size:17px;color:#fff}
.modal-close{background:rgba(255,255,255,0.15);border:none;color:#fff;width:30px;height:30px;border-radius:50%;cursor:pointer;font-size:16px;display:flex;align-items:center;justify-content:center}
.modal-body{padding:24px}
.modal-section{margin-bottom:20px}
.modal-section-title{font-size:11px;font-weight:800;text-transform:uppercase;letter-spacing:.8px;color:var(--text3);margin-bottom:10px;padding-bottom:6px;border-bottom:1px solid var(--border)}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px}
.form-group{margin-bottom:10px}
.form-label{font-size:11px;font-weight:700;color:var(--text2);margin-bottom:4px;display:block}
.form-input{width:100%;background:var(--surf2);border:1.5px solid var(--border);border-radius:var(--r-sm);padding:9px 12px;font-size:13px;color:var(--text);font-family:'DM Sans',sans-serif;outline:none;transition:border-color .2s}
.form-input:focus{border-color:var(--navy)}
.driver-select{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:10px}
.driver-option{padding:10px;border:2px solid var(--border);border-radius:var(--r-sm);cursor:pointer;transition:all .2s;background:#fff}
.driver-option:hover{border-color:var(--navy);background:rgba(43,43,168,0.04)}
.driver-option.selected{border-color:var(--orange);background:rgba(244,121,32,0.06)}
.driver-name{font-weight:700;font-size:13px;color:var(--text)}
.driver-vehicle{font-size:11px;color:var(--text3)}
.driver-location{font-size:10px;color:var(--text3);margin-top:2px}
.modal-footer{padding:16px 24px;border-top:1px solid var(--border);display:flex;gap:10px;justify-content:flex-end}
.btn-cancel{background:transparent;border:1.5px solid var(--border);color:var(--text2);padding:10px 20px;border-radius:var(--r-sm);cursor:pointer;font-size:13px;font-weight:600;font-family:'DM Sans',sans-serif}
.btn-confirm{background:linear-gradient(135deg,var(--green),#15803d);color:#fff;border:none;padding:10px 24px;border-radius:var(--r-sm);cursor:pointer;font-size:13px;font-weight:800;font-family:'Syne',sans-serif}

/* CONSIGNMENT NOTE MODAL */
.cn-modal{max-width:680px}
.cn-header-branded{background:linear-gradient(135deg,var(--navy),var(--navy2));padding:24px;text-align:center;border-radius:16px 16px 0 0}
.cn-logo-text{font-family:'Syne',sans-serif;font-weight:800;font-size:22px;color:#fff;letter-spacing:1px}
.cn-doc-title{font-size:13px;color:rgba(255,255,255,0.8);letter-spacing:3px;text-transform:uppercase;margin-top:4px}
.cn-ref{background:var(--orange);color:#fff;display:inline-block;padding:4px 12px;border-radius:6px;font-family:'JetBrains Mono',monospace;font-size:12px;font-weight:700;margin-top:8px}
.cn-body{padding:24px}
.cn-grid{display:grid;grid-template-columns:1fr 1fr;gap:0;border:1px solid rgba(43,43,168,0.2);border-radius:var(--r-sm);overflow:hidden;margin-bottom:16px}
.cn-field{padding:10px 14px;border-bottom:1px solid rgba(43,43,168,0.1)}
.cn-field:nth-child(odd){border-right:1px solid rgba(43,43,168,0.1)}
.cn-field-label{font-size:9px;font-weight:800;text-transform:uppercase;letter-spacing:.6px;color:var(--text3);margin-bottom:3px}
.cn-field-value{font-size:13px;font-weight:600;color:var(--text)}
.cn-full{grid-column:1/-1}
.cn-stamp{display:flex;gap:16px;justify-content:space-between;margin-top:16px}
.cn-stamp-box{flex:1;border:2px solid var(--border);border-radius:var(--r-sm);padding:16px;text-align:center}
.cn-stamp-label{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--text3);margin-bottom:24px}
.cn-stamp-line{border-top:1px solid var(--border);margin-top:8px;padding-top:6px;font-size:10px;color:var(--text3)}
.cn-footer{background:var(--surf2);border-top:1px solid var(--border);padding:14px 24px;display:flex;gap:10px;justify-content:flex-end;border-radius:0 0 16px 16px}
.btn-print{background:linear-gradient(135deg,var(--navy),var(--navy2));color:#fff;border:none;padding:10px 20px;border-radius:var(--r-sm);cursor:pointer;font-size:13px;font-weight:700;font-family:'DM Sans',sans-serif}
.btn-new{background:linear-gradient(135deg,var(--orange),var(--og-dk));color:#fff;border:none;padding:10px 20px;border-radius:var(--r-sm);cursor:pointer;font-size:13px;font-weight:700;font-family:'DM Sans',sans-serif}

/* SCORE TOAST */
.score-toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%);background:var(--surface);border:1px solid var(--border);border-radius:var(--r);padding:14px 24px;box-shadow:var(--sh-lg);z-index:600;display:none;align-items:center;gap:12px;min-width:300px}
.score-toast.show{display:flex;animation:slideUp .3s ease}
@keyframes slideUp{from{transform:translateX(-50%) translateY(20px);opacity:0}to{transform:translateX(-50%) translateY(0);opacity:1}}
.score-emoji{font-size:24px}
.score-text .score-title{font-family:'Syne',sans-serif;font-weight:800;font-size:14px;color:var(--navy)}
.score-text .score-xp{font-size:12px;color:var(--orange);font-weight:700}

/* EMPTY STATE */
.no-loads{padding:40px;text-align:center;color:var(--text3);font-size:13px}

/* SESSION STATS */
.session-bar{grid-column:1/-1;background:linear-gradient(135deg,var(--navy),var(--navy2));border-radius:var(--r);padding:16px 20px;display:flex;align-items:center;gap:20px;flex-wrap:wrap}
.session-bar .s-title{font-family:'Syne',sans-serif;font-weight:800;font-size:14px;color:#fff;flex-shrink:0}
.session-stat{display:flex;align-items:center;gap:8px}
.session-stat .sv{font-family:'Syne',sans-serif;font-weight:800;font-size:18px;color:#fff}
.session-stat .sl{font-size:11px;color:rgba(255,255,255,0.7)}
.session-sep{width:1px;height:30px;background:rgba(255,255,255,0.15)}
.xp-pill{margin-left:auto;background:var(--orange);color:#fff;font-family:'Syne',sans-serif;font-weight:800;font-size:14px;padding:6px 16px;border-radius:20px}
</style>
</head>
<body>

<!-- HEADER -->
<header class="ex-header">
  <div class="ex-header-inner">
    <a href="index.html" class="ex-logo">
      <div class="ex-logo-icon">ğŸ¦…</div>
      <div class="ex-logo-text">
        <div class="name">EAGLE EXCHANGE</div>
        <div class="sub">UK Load Board Simulator</div>
      </div>
    </a>
    <span class="ex-badge">TRAINING MODE</span>
    <div class="ex-nav-back">
      <div class="live-clock">
        <span class="uk-label">UK </span><span id="uk-time">--:--</span>
        &nbsp;|&nbsp;
        <span class="uk-label">IST </span><span id="ist-time">--:--</span>
      </div>
      <a href="tools.html">â† Tools</a>
      <a href="week1.html">Week 1</a>
    </div>
  </div>
</header>

<!-- TICKER -->
<div class="ex-ticker">
  <div class="ex-ticker-inner">
    <span><span class="dot">â—</span> Courier Exchange (CX) â€” UK's real load board. This simulator trains you for the real thing.</span>
    <span><span class="dot">â—</span> Always check CX Credit Rating before booking â€” never accept below 70</span>
    <span><span class="dot">â—</span> UK CPM target: Â£1.80â€“Â£3.00 per mile depending on vehicle type</span>
    <span><span class="dot">â—</span> O-Licence check: vehicle-operator-licensing.service.gov.uk â€” verify every new carrier</span>
    <span><span class="dot">â—</span> UK business hours: 09:00â€“17:30 GMT = 14:30â€“23:00 IST â€” your Xeagle shift</span>
    <span><span class="dot">â—</span> Courier Exchange (CX) â€” UK's real load board. This simulator trains you for the real thing.</span>
    <span><span class="dot">â—</span> Always check CX Credit Rating before booking â€” never accept below 70</span>
    <span><span class="dot">â—</span> UK CPM target: Â£1.80â€“Â£3.00 per mile depending on vehicle type</span>
    <span><span class="dot">â—</span> O-Licence check: vehicle-operator-licensing.service.gov.uk â€” verify every new carrier</span>
    <span><span class="dot">â—</span> UK business hours: 09:00â€“17:30 GMT = 14:30â€“23:00 IST â€” your Xeagle shift</span>
  </div>
</div>

<div style="max-width:1400px;margin:0 auto;padding:16px 20px 0">
  <!-- SESSION STATS BAR -->
  <div class="session-bar" id="session-bar">
    <span class="s-title">ğŸ¦… Today's Session</span>
    <div class="session-sep"></div>
    <div class="session-stat"><span class="sv" id="s-booked">0</span><span class="sl">Loads Booked</span></div>
    <div class="session-sep"></div>
    <div class="session-stat"><span class="sv" id="s-revenue">Â£0</span><span class="sl">Revenue Secured</span></div>
    <div class="session-sep"></div>
    <div class="session-stat"><span class="sv" id="s-fee">Â£0</span><span class="sl">Xeagle Fee (8%)</span></div>
    <div class="session-sep"></div>
    <div class="session-stat"><span class="sv" id="s-best">â€”</span><span class="sl">Best Negotiation</span></div>
    <div class="session-sep"></div>
    <div class="session-stat"><span class="sv" id="s-grade">â€”</span><span class="sl">Grade</span></div>
    <div class="xp-pill">âš¡ <span id="s-xp">0</span> XP</div>
  </div>
</div>

<!-- MAIN LAYOUT -->
<div class="ex-wrap">
  <!-- STATS CARDS -->
  <div class="stats-bar">
    <div class="stat-card">
      <div class="stat-icon" style="background:rgba(43,43,168,0.10)">ğŸšš</div>
      <div><div class="stat-val" id="st-available">15</div><div class="stat-lbl">Loads Available</div></div>
    </div>
    <div class="stat-card">
      <div class="stat-icon" style="background:rgba(220,38,38,0.10)">ğŸ”´</div>
      <div><div class="stat-val" id="st-urgent">3</div><div class="stat-lbl">Urgent Loads</div></div>
    </div>
    <div class="stat-card">
      <div class="stat-icon" style="background:rgba(22,163,74,0.10)">âœ…</div>
      <div><div class="stat-val" id="st-booked">0</div><div class="stat-lbl">You've Booked</div></div>
    </div>
    <div class="stat-card">
      <div class="stat-icon" style="background:rgba(244,121,32,0.10)">ğŸ’·</div>
      <div><div class="stat-val" id="st-xp">0</div><div class="stat-lbl">XP Earned</div></div>
    </div>
  </div>

  <!-- LOAD BOARD -->
  <div class="board-panel">
    <div class="board-header">
      <div>
        <div class="board-title">ğŸ¦… Eagle Exchange â€” Live UK Loads</div>
        <div class="board-subtitle">Click any load to view details and negotiate</div>
      </div>
      <button class="board-refresh" onclick="refreshLoads()">â†» Refresh</button>
    </div>
    <div class="board-filters">
      <select class="filter-select" id="filter-vehicle" onchange="applyFilters()">
        <option value="">All Vehicles</option>
        <option value="Curtainsider">Curtainsider</option>
        <option value="Box Van">Box Van</option>
        <option value="Flatbed">Flatbed</option>
        <option value="Refrigerated">Refrigerated</option>
        <option value="Tanker">Tanker</option>
        <option value="Low Loader">Low Loader</option>
      </select>
      <select class="filter-select" id="filter-region" onchange="applyFilters()">
        <option value="">All Regions</option>
        <option value="London">London</option>
        <option value="Midlands">Midlands</option>
        <option value="North">North England</option>
        <option value="Scotland">Scotland</option>
        <option value="South West">South West</option>
        <option value="Wales">Wales</option>
      </select>
      <select class="filter-select" id="filter-sort" onchange="applyFilters()">
        <option value="time">Sort: Collection Time</option>
        <option value="rate-high">Sort: Rate (Highâ†’Low)</option>
        <option value="rate-low">Sort: Rate (Lowâ†’High)</option>
        <option value="cpm">Sort: CPM (Best)</option>
        <option value="distance">Sort: Distance</option>
      </select>
      <input class="filter-search" id="filter-search" placeholder="Search city, vehicleâ€¦" oninput="applyFilters()"/>
      <span class="filter-count" id="filter-count">15 loads</span>
    </div>
    <div class="load-list" id="load-list"></div>
  </div>

  <!-- DETAIL PANEL -->
  <div class="detail-panel" id="detail-panel">
    <div class="detail-empty" id="detail-empty">
      <div class="big-icon">ğŸš›</div>
      <p><strong>Select a load from the board</strong><br/>to view full details and start negotiating</p>
      <br/>
      <p style="font-size:11px;color:var(--text3)">ğŸ’¡ Tip: Check the CX Rating before you negotiate.<br/>Below 70 = walk away!</p>
    </div>
    <div id="detail-content" style="display:none"></div>
  </div>
</div>

<!-- BOOKING MODAL -->
<div class="modal-overlay" id="booking-modal">
  <div class="modal">
    <div class="modal-header">
      <span class="modal-title">ğŸ“‹ Book This Load</span>
      <button class="modal-close" onclick="closeModal('booking-modal')">âœ•</button>
    </div>
    <div class="modal-body">
      <div class="modal-section">
        <div class="modal-section-title">Load Details</div>
        <div id="modal-load-summary" style="background:var(--surf2);border:1px solid var(--border);border-radius:var(--r-sm);padding:12px;font-size:13px;color:var(--text);font-weight:600"></div>
      </div>
      <div class="modal-section">
        <div class="modal-section-title">Select Driver</div>
        <div class="driver-select" id="driver-select">
          <!-- populated by JS -->
        </div>
      </div>
      <div class="modal-section">
        <div class="modal-section-title">Collection Details</div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Collection Address</label>
            <input class="form-input" id="f-collection" placeholder="e.g. Unit 4, Birmingham Business Park"/>
          </div>
          <div class="form-group">
            <label class="form-label">Collection Contact</label>
            <input class="form-input" id="f-col-contact" placeholder="e.g. Dave â€” 07700 900123"/>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Delivery Address</label>
            <input class="form-input" id="f-delivery" placeholder="e.g. Glasgow Distribution Centre"/>
          </div>
          <div class="form-group">
            <label class="form-label">Delivery Contact</label>
            <input class="form-input" id="f-del-contact" placeholder="e.g. Sandra â€” 07700 900456"/>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Special Instructions</label>
          <input class="form-input" id="f-instructions" placeholder="e.g. Tail-lift required, call 30 mins before arrival"/>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-cancel" onclick="closeModal('booking-modal')">Cancel</button>
      <button class="btn-confirm" onclick="confirmBooking()">âœ… Confirm Booking & Generate Consignment Note</button>
    </div>
  </div>
</div>

<!-- CONSIGNMENT NOTE MODAL -->
<div class="modal-overlay" id="cn-modal">
  <div class="modal cn-modal">
    <div class="cn-header-branded">
      <div class="cn-logo-text">EAGLE EXCHANGE</div>
      <div class="cn-doc-title">UK Consignment Note</div>
      <div class="cn-ref" id="cn-ref">EX-000000</div>
    </div>
    <div class="cn-body" id="cn-body"><!-- populated by JS --></div>
    <div class="cn-footer">
      <button class="btn-cancel" onclick="closeModal('cn-modal')">Close</button>
      <button class="btn-print" onclick="printCN()">ğŸ–¨ï¸ Print Note</button>
      <button class="btn-new" onclick="closeModal('cn-modal');refreshLoads()">ğŸ“¦ Find Next Load</button>
    </div>
  </div>
</div>

<!-- SCORE TOAST -->
<div class="score-toast" id="score-toast">
  <div class="score-emoji" id="toast-emoji">ğŸ‰</div>
  <div class="score-text">
    <div class="score-title" id="toast-title">Great negotiation!</div>
    <div class="score-xp" id="toast-xp">+120 XP earned</div>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  EAGLE EXCHANGE â€” LOAD BOARD ENGINE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// LIVE CLOCK
function updateClock(){
  const now = new Date();
  // UK time (GMT, simplified)
  const ukOffset = 0; // GMT, adjust for BST in summer
  const uk = new Date(now.getTime() + (ukOffset * 60 - now.getTimezoneOffset()) * 60000);
  const ist = new Date(now.getTime() + (330 - now.getTimezoneOffset()) * 60000);
  const fmt = d => d.getHours().toString().padStart(2,'0') + ':' + d.getMinutes().toString().padStart(2,'0');
  document.getElementById('uk-time').textContent = fmt(uk);
  document.getElementById('ist-time').textContent = fmt(ist);
}
updateClock(); setInterval(updateClock, 1000);

// SESSION STATE
let session = {
  booked: 0, revenue: 0, xp: 0,
  negoWins: 0, bestRateAbove: 0
};

function updateSessionBar(){
  document.getElementById('s-booked').textContent = session.booked;
  document.getElementById('s-revenue').textContent = 'Â£' + session.revenue.toLocaleString();
  document.getElementById('s-fee').textContent = 'Â£' + Math.round(session.revenue * 0.08).toLocaleString();
  document.getElementById('s-best').textContent = session.bestRateAbove > 0 ? '+Â£' + session.bestRateAbove + ' above offer' : 'â€”';
  document.getElementById('s-xp').textContent = session.xp;
  document.getElementById('st-booked').textContent = session.booked;
  document.getElementById('st-xp').textContent = session.xp;
  // Grade
  let grade = 'â€”';
  if(session.booked >= 1) grade = 'Rookie ğŸŸ¡';
  if(session.booked >= 3) grade = 'Dispatcher ğŸŸ¢';
  if(session.booked >= 5 && session.negoWins >= 2) grade = 'Pro â­';
  if(session.booked >= 7 && session.negoWins >= 4) grade = 'Senior ğŸ†';
  document.getElementById('s-grade').textContent = grade;
}

// LOAD DATA
const BROKERS = [
  {name:'Morris Freight Ltd', location:'Manchester', cx:92, type:'green'},
  {name:'Apex Logistics UK', location:'Birmingham', cx:87, type:'green'},
  {name:'TruckLine Solutions', location:'Leeds', cx:78, type:'green'},
  {name:'Northern Roads Ltd', location:'Newcastle', cx:74, type:'amber'},
  {name:'FastHaul UK', location:'Bristol', cx:85, type:'green'},
  {name:'Premier Transport', location:'London', cx:91, type:'green'},
  {name:'MidEx Freight', location:'Coventry', cx:65, type:'red'},
  {name:'Scottish Haulage Co', location:'Glasgow', cx:82, type:'green'},
  {name:'Southern Logistics', location:'Southampton', cx:68, type:'red'},
  {name:'AtoB Freight', location:'Sheffield', cx:79, type:'green'},
  {name:'Coastal Carriers', location:'Felixstowe', cx:88, type:'green'},
  {name:'Trans-UK Ltd', location:'Nottingham', cx:71, type:'amber'},
];

const VEHICLE_TYPES = ['Curtainsider','Box Van','Flatbed','Refrigerated','Tanker','Low Loader','Curtainsider','Curtainsider','Box Van','Refrigerated'];

const ALL_LOADS = [
  {id:'EX001',from:'Birmingham',fromRegion:'Midlands',to:'Glasgow',miles:305,vehicle:'Curtainsider',weight:'24t',goods:'Automotive Parts',col:'08:00',del:'18:00',rate:1920,urgent:false,broker:0,notes:'Tail-lift required at collection'},
  {id:'EX002',from:'London',fromRegion:'London',to:'Manchester',miles:212,vehicle:'Refrigerated',weight:'18t',goods:'Fresh Produce',col:'06:30',del:'12:00',rate:1450,urgent:true,broker:1,notes:'Temperature controlled: 2-4Â°C. Temp log required.'},
  {id:'EX003',from:'Bristol',fromRegion:'South West',to:'Leeds',miles:208,vehicle:'Box Van',weight:'3.5t',goods:'Retail Clothing',col:'09:00',del:'16:00',rate:640,urgent:false,broker:2,notes:'2 drop points: Leeds city centre, then Wakefield'},
  {id:'EX004',from:'Manchester',fromRegion:'North',to:'Southampton',miles:247,vehicle:'Curtainsider',weight:'26t',goods:'Steel Coils',col:'07:00',del:'15:30',rate:1680,urgent:false,broker:5,notes:'Coil bolsters required. Strapping to be checked by driver.'},
  {id:'EX005',from:'Leeds',fromRegion:'North',to:'London',miles:204,vehicle:'Refrigerated',weight:'20t',goods:'Dairy Products',col:'05:00',del:'11:00',rate:1580,urgent:true,broker:0,notes:'URGENT â€” early delivery required. Dock 7 only.'},
  {id:'EX006',from:'Glasgow',fromRegion:'Scotland',to:'Birmingham',miles:303,vehicle:'Curtainsider',weight:'22t',goods:'Whisky Barrels',col:'10:00',del:'20:00',rate:1840,urgent:false,broker:7,notes:'Fragile â€” careful loading, max 2 straps per barrel'},
  {id:'EX007',from:'London',fromRegion:'London',to:'Edinburgh',miles:414,vehicle:'Flatbed',weight:'15t',goods:'Construction Equipment',col:'07:30',del:'18:00',rate:2240,urgent:false,broker:5,notes:'Abnormal width â€” escort required M1/M6 section'},
  {id:'EX008',from:'Cardiff',fromRegion:'Wales',to:'Sheffield',miles:178,vehicle:'Box Van',weight:'4t',goods:'Electrical Components',col:'09:30',del:'15:00',rate:540,urgent:false,broker:2,notes:''},
  {id:'EX009',from:'Newcastle',fromRegion:'North',to:'Bristol',miles:308,vehicle:'Curtainsider',weight:'25t',goods:'FMCG Goods',col:'06:00',del:'17:00',rate:1760,urgent:false,broker:6,notes:'âš ï¸ CHECK CX RATING â€” payment history flagged'},
  {id:'EX010',from:'Southampton',fromRegion:'South West',to:'Glasgow',miles:448,vehicle:'Refrigerated',weight:'22t',goods:'Seafood',col:'04:00',del:'14:00',rate:2680,urgent:true,broker:4,notes:'Temperature: 0-2Â°C. Urgent â€” vessel just docked at port.'},
  {id:'EX011',from:'Birmingham',fromRegion:'Midlands',to:'Edinburgh',miles:320,vehicle:'Tanker',weight:'28t',goods:'Food Grade Liquid',col:'08:30',del:'19:00',rate:2180,urgent:false,broker:1,notes:'Food grade tanker only. ADR certificate required.'},
  {id:'EX012',from:'Liverpool',fromRegion:'North',to:'London',miles:218,vehicle:'Curtainsider',weight:'24t',goods:'Retail Products',col:'11:00',del:'19:30',rate:1340,urgent:false,broker:9,notes:''},
  {id:'EX013',from:'Manchester',fromRegion:'North',to:'Cardiff',miles:198,vehicle:'Box Van',weight:'3.5t',goods:'Medical Supplies',col:'08:00',del:'13:00',rate:720,urgent:false,broker:0,notes:'Medical â€” white glove handling required'},
  {id:'EX014',from:'Felixstowe',fromRegion:'London',to:'Birmingham',miles:148,vehicle:'Flatbed',weight:'20t',goods:'Port Containers',col:'10:30',del:'16:00',rate:1120,urgent:false,broker:10,notes:'Port container â€” driver must have valid DCSA card'},
  {id:'EX015',from:'Bristol',fromRegion:'South West',to:'Glasgow',miles:383,vehicle:'Low Loader',weight:'40t',goods:'Agricultural Machinery',col:'07:00',del:'20:00',rate:2840,urgent:false,broker:8,notes:'âš ï¸ POOR CX RATING â€” verify payment before accepting'},
];

// Mark booked loads
let bookedIds = JSON.parse(localStorage.getItem('ex_booked') || '[]');
let currentLoad = null;
let negoState = null;
let negotiatedRate = null;
let selectedDriver = null;

function getCPM(load){ return (load.rate / load.miles).toFixed(2); }
function getCXClass(score){ if(score>=80)return 'cx-green'; if(score>=70)return 'cx-amber'; return 'cx-red'; }
function getCXBig(score){ if(score>=80)return 'cx-green'; if(score>=70)return 'cx-amber'; return 'cx-red'; }

// RENDER LOAD LIST
let filteredLoads = [...ALL_LOADS];

function applyFilters(){
  const v = document.getElementById('filter-vehicle').value;
  const r = document.getElementById('filter-region').value;
  const s = document.getElementById('filter-sort').value;
  const q = document.getElementById('filter-search').value.toLowerCase();

  filteredLoads = ALL_LOADS.filter(l => {
    if(v && l.vehicle !== v) return false;
    if(r && l.fromRegion !== r) return false;
    if(q && !l.from.toLowerCase().includes(q) && !l.to.toLowerCase().includes(q) && !l.vehicle.toLowerCase().includes(q)) return false;
    return true;
  });

  if(s==='rate-high') filteredLoads.sort((a,b)=>b.rate-a.rate);
  else if(s==='rate-low') filteredLoads.sort((a,b)=>a.rate-b.rate);
  else if(s==='cpm') filteredLoads.sort((a,b)=>(b.rate/b.miles)-(a.rate/a.miles));
  else if(s==='distance') filteredLoads.sort((a,b)=>b.miles-a.miles);
  else filteredLoads.sort((a,b)=>a.col.localeCompare(b.col));

  document.getElementById('filter-count').textContent = filteredLoads.length + ' load' + (filteredLoads.length!==1?'s':'');
  renderLoadList();
}

function renderLoadList(){
  const list = document.getElementById('load-list');
  if(!filteredLoads.length){
    list.innerHTML = '<div class="no-loads">No loads match your filters.<br/>Try adjusting or clearing filters.</div>';
    return;
  }

  list.innerHTML = filteredLoads.map(l => {
    const b = BROKERS[l.broker];
    const cpm = getCPM(l);
    const isBooked = bookedIds.includes(l.id);
    const isSelected = currentLoad && currentLoad.id === l.id;
    const cpmNum = parseFloat(cpm);
    const cpmColor = cpmNum >= 2.50 ? 'color:var(--green)' : cpmNum >= 1.80 ? 'color:var(--amber)' : 'color:var(--red)';

    return `
    <div class="load-item ${l.urgent?'urgent':''} ${isSelected?'selected':''} ${isBooked?'booked':''}"
         onclick="${isBooked?'':("selectLoad('"+l.id+"')")}"
         id="li-${l.id}">
      ${isBooked ? '<div class="load-booked-badge">âœ… Booked</div>' : ''}
      <div class="load-route">
        <span class="load-city">${l.from}</span>
        <span class="load-arrow">â†’</span>
        <span class="load-city">${l.to}</span>
      </div>
      <div class="load-meta">
        <span class="load-tag lt-vehicle">ğŸšš ${l.vehicle}</span>
        <span class="load-tag lt-weight">âš–ï¸ ${l.weight}</span>
        <span class="load-tag lt-distance">ğŸ“ ${l.miles} mi</span>
        <span class="load-tag lt-collection">ğŸ• Col: ${l.col}</span>
      </div>
      <div class="load-bottom">
        <div>
          <div class="load-rate">Â£${l.rate.toLocaleString()}</div>
          <div class="load-cpm" style="${cpmColor}">Â£${cpm}/mi CPM</div>
        </div>
        <div class="load-broker">
          <div>
            <div class="broker-name">${b.name}</div>
            <div style="text-align:right;margin-top:2px">
              <span class="cx-score ${getCXClass(b.cx)}">CX: ${b.cx}</span>
            </div>
          </div>
        </div>
      </div>
    </div>`;
  }).join('');
}

function selectLoad(id){
  currentLoad = ALL_LOADS.find(l=>l.id===id);
  if(!currentLoad) return;
  negoState = null;
  negotiatedRate = null;
  selectedDriver = null;
  document.querySelectorAll('.load-item').forEach(el=>el.classList.remove('selected'));
  const el = document.getElementById('li-'+id);
  if(el) el.classList.add('selected');
  renderDetail();
}

function renderDetail(){
  const l = currentLoad;
  const b = BROKERS[l.broker];
  const cpm = getCPM(l);
  const cpmNum = parseFloat(cpm);
  const cpmColor = cpmNum >= 2.50 ? 'var(--green)' : cpmNum >= 1.80 ? 'var(--amber)' : 'var(--red)';

  document.getElementById('detail-empty').style.display = 'none';
  document.getElementById('detail-content').style.display = 'block';

  const hasWarning = b.cx < 70;
  const isBooked = bookedIds.includes(l.id);

  document.getElementById('detail-content').innerHTML = `
    <div class="detail-header">
      <div class="detail-route">
        <span class="detail-city">${l.from}</span>
        <span class="detail-arrow">â†’</span>
        <span class="detail-city">${l.to}</span>
      </div>
      <div class="detail-rate-big">Â£${l.rate.toLocaleString()}</div>
      <div class="detail-cpm-big" style="color:${cpmColor}">Â£${cpm} per mile Â· ${l.miles} miles</div>
      ${l.urgent ? '<div class="detail-urgency">âš¡ URGENT LOAD</div>' : ''}
    </div>
    <div class="detail-body">
      <div class="detail-section">
        <div class="detail-section-title">Load Information</div>
        <div class="detail-grid">
          <div class="detail-field"><div class="detail-field-label">Vehicle Required</div><div class="detail-field-value">ğŸšš ${l.vehicle}</div></div>
          <div class="detail-field"><div class="detail-field-label">Max Weight</div><div class="detail-field-value">âš–ï¸ ${l.weight}</div></div>
          <div class="detail-field"><div class="detail-field-label">Goods Type</div><div class="detail-field-value">ğŸ“¦ ${l.goods}</div></div>
          <div class="detail-field"><div class="detail-field-label">Distance</div><div class="detail-field-value">ğŸ“ ${l.miles} miles</div></div>
          <div class="detail-field"><div class="detail-field-label">Collection Time</div><div class="detail-field-value">ğŸ• ${l.col} today</div></div>
          <div class="detail-field"><div class="detail-field-label">Delivery By</div><div class="detail-field-value">ğŸ¯ ${l.del} today</div></div>
        </div>
        ${l.notes ? `<div style="background:rgba(244,121,32,0.06);border-left:3px solid var(--orange);padding:10px 12px;border-radius:0 var(--r-sm) var(--r-sm) 0;margin-top:8px;font-size:12px;color:var(--text2)"><strong>ğŸ“‹ Notes:</strong> ${l.notes}</div>` : ''}
      </div>
      <div class="detail-section">
        <div class="detail-section-title">Load Poster (Broker)</div>
        <div class="broker-card">
          <div class="broker-info">
            <div class="bname">${b.name}</div>
            <div class="bloc">ğŸ“ ${b.location}</div>
          </div>
          <span class="cx-score-big ${getCXBig(b.cx)}">CX: ${b.cx}</span>
        </div>
        ${hasWarning ?
          '<div class="broker-warning">âš ï¸ CX Rating below 70 â€” HIGH RISK. This broker has poor payment history. Instructor: discuss whether to proceed and why.</div>' :
          '<div class="broker-good">âœ… CX Rating above 70 â€” Safe to negotiate</div>'
        }
      </div>
    </div>
    <div class="nego-panel" id="nego-section">
      ${isBooked ? '<div class="nego-result win">âœ… Already booked â€” find your next load!</div>' : renderNegoPanel()}
    </div>`;
}

function renderNegoPanel(state){
  const l = currentLoad;
  const offered = l.rate;
  const roundsLeft = state ? state.roundsLeft : 3;
  const disabled = roundsLeft <= 0 || (state && state.done);

  let historyHTML = '';
  if(state && state.history && state.history.length){
    historyHTML = state.history.map(m=>`<div class="nego-msg ${m.type}">${m.text}</div>`).join('');
  }

  let resultHTML = '';
  if(state && state.result){
    resultHTML = `<div class="nego-result ${state.result.type}">${state.result.text}</div>`;
  }

  const showBookBtn = state && state.done && state.result && state.result.type !== 'lose';

  return `
    <div class="nego-title">ğŸ’¬ Rate Negotiation</div>
    <div class="nego-sub">The broker has offered Â£${offered.toLocaleString()}. Enter your counter-offer. You have ${3} rounds maximum.</div>
    <div class="nego-offer">
      <div class="nego-offer-label">Broker's Current Offer</div>
      <div class="nego-offer-amount">Â£${(state && state.currentOffer ? state.currentOffer : offered).toLocaleString()}</div>
    </div>
    ${historyHTML ? '<div class="nego-history">'+historyHTML+'</div>' : ''}
    ${resultHTML}
    <div class="nego-input-row">
      <input class="nego-input" id="nego-input" type="number" placeholder="Enter your counter Â£" min="${offered}" max="${Math.round(offered*1.5)}" ${disabled?'disabled':''} onkeydown="if(event.key==='Enter')submitNego()"/>
      <button class="nego-btn" onclick="submitNego()" ${disabled?'disabled':''}>Counter â†’</button>
    </div>
    <div class="nego-rounds" id="nego-rounds">${disabled ? '' : `${roundsLeft} round${roundsLeft!==1?'s':''} remaining`}</div>
    <button class="book-btn ${showBookBtn?'show':''}" onclick="openBookingModal()">ğŸ“‹ Book This Load â€” Â£${(negotiatedRate||offered).toLocaleString()}</button>
    ${!showBookBtn && !disabled ? '<button class="book-btn show" style="background:linear-gradient(135deg,#64748b,#475569)" onclick="acceptOffer()">Accept Offered Rate â€” Â£'+offered.toLocaleString()+'</button>' : ''}`;
}

function submitNego(){
  const input = document.getElementById('nego-input');
  const val = parseInt(input.value);
  const offered = currentLoad.rate;

  if(!val || val < offered){
    input.style.borderColor = 'var(--red)';
    setTimeout(()=>input.style.borderColor='',1000);
    showToast('âš ï¸','Enter a valid counter â€” must be at or above offer price','');
    return;
  }

  if(!negoState) negoState = {roundsLeft:3, history:[], currentOffer:offered, done:false};

  const diff = val - negoState.currentOffer;
  const pct = (diff / negoState.currentOffer) * 100;

  negoState.history.push({type:'dispatcher', text:`You: Offered Â£${val.toLocaleString()}`});
  negoState.roundsLeft--;

  let brokerResponse, resultType = null, accepted = false;

  if(pct <= 5){
    // Broker accepts
    negotiatedRate = val;
    brokerResponse = getBrokerAccept(val);
    negoState.done = true;
    accepted = true;
    resultType = 'win';
    negoState.result = {type:'win', text:`ğŸ‰ Deal! Negotiated Â£${val.toLocaleString()} â€” Â£${val-offered} above offer (${((val-offered)/offered*100).toFixed(1)}% above)`};
    const earned = val - offered;
    if(earned > session.bestRateAbove) session.bestRateAbove = earned;
    session.negoWins++;
    const xp = 80 + Math.round(pct * 10);
    session.xp += xp;
    updateSessionBar();
    showToast('ğŸ‰', 'Deal secured! +Â£'+earned+' above offer', '+'+xp+' XP earned');
  } else if(pct <= 18 && negoState.roundsLeft > 0){
    // Counter
    const counter = Math.round(negoState.currentOffer + diff * 0.4);
    negoState.currentOffer = counter;
    brokerResponse = getBrokerCounter(counter, negoState.roundsLeft);
    negoState.history.push({type:'broker', text:`Broker: ${brokerResponse}`});
  } else if(negoState.roundsLeft <= 0){
    // Out of rounds â€” auto accept current offer
    negotiatedRate = negoState.currentOffer;
    negoState.done = true;
    accepted = true;
    negoState.result = {type:'partial', text:`â±ï¸ Rounds used â€” accepted at Â£${negoState.currentOffer.toLocaleString()}. Practice tip: start closer to market rate!`};
    session.xp += 40;
    updateSessionBar();
    showToast('â±ï¸','Out of rounds â€” accepted at offer rate','+40 XP');
  } else {
    // Too high â€” broker walks
    brokerResponse = getBrokerReject();
    negoState.history.push({type:'broker', text:`Broker: ${brokerResponse}`});
    negoState.done = true;
    negoState.result = {type:'lose', text:`âŒ Broker walked away â€” your counter was too high. Reload and try again!`};
    session.xp += 10;
    updateSessionBar();
    showToast('âŒ','Broker walked away â€” counter was too high','+10 XP');
  }

  if(!accepted && pct <= 18 && negoState.roundsLeft > 0){
    // Still negotiating
  } else if(!negoState.history.find(m=>m.type==='broker' && m.text.includes('Broker:')) && accepted){
    negoState.history.push({type:'broker', text:`Broker: ${brokerResponse}`});
  }

  if(!accepted && pct > 18){
    // Already handled above
  }

  const ns = document.getElementById('nego-section');
  if(ns) ns.innerHTML = renderNegoPanel(negoState);
}

function acceptOffer(){
  negotiatedRate = currentLoad.rate;
  negoState = negoState || {history:[], roundsLeft:3, done:true, currentOffer:currentLoad.rate};
  negoState.done = true;
  negoState.result = {type:'partial', text:`ğŸ“Œ Accepted at offered rate â€” Â£${currentLoad.rate.toLocaleString()}. Next time try to negotiate higher!`};
  session.xp += 30;
  updateSessionBar();
  const ns = document.getElementById('nego-section');
  if(ns) ns.innerHTML = renderNegoPanel(negoState);
}

function getBrokerAccept(rate){
  const phrases = [
    `Alright, Â£${rate.toLocaleString()} it is. Can you confirm collection for ${currentLoad.col}?`,
    `Fair enough mate â€” Â£${rate.toLocaleString()} works. What's your vehicle reg?`,
    `Done at Â£${rate.toLocaleString()}. Send me the driver details and I'll issue the paperwork.`,
    `Right, we'll go Â£${rate.toLocaleString()}. Driver needs to be there by ${currentLoad.col} sharp.`,
  ];
  return phrases[Math.floor(Math.random()*phrases.length)];
}
function getBrokerCounter(counter, rounds){
  const phrases = [
    `Best I can do is Â£${counter.toLocaleString()}. We're not far off â€” what do you say?`,
    `Look, I can go to Â£${counter.toLocaleString()} but that's my final offer on this one.`,
    `I'll meet you halfway at Â£${counter.toLocaleString()}. Solid load, worth it.`,
    `Â£${counter.toLocaleString()} and we have a deal â€” but I need a decision now, I have another carrier waiting.`,
  ];
  return phrases[Math.floor(Math.random()*phrases.length)];
}
function getBrokerReject(){
  const phrases = [
    `That's way over budget mate. I'll have to go elsewhere. Thanks anyway.`,
    `No chance at that rate. I've got three other carriers interested. Good luck.`,
    `That doesn't work for us. We'll pass â€” thanks for calling.`,
    `Sorry, that's not going to work. I need to move on.`,
  ];
  return phrases[Math.floor(Math.random()*phrases.length)];
}

// ACCEPT OFFER BUTTON
function openBookingModal(){
  if(!currentLoad || !negotiatedRate) return;
  const b = BROKERS[currentLoad.broker];
  const l = currentLoad;

  document.getElementById('modal-load-summary').innerHTML =
    `<strong>${l.from} â†’ ${l.to}</strong> Â· ${l.miles} miles Â· ${l.vehicle}<br/>
     Agreed Rate: <strong style="color:var(--navy);font-family:'Syne',sans-serif;font-size:16px">Â£${negotiatedRate.toLocaleString()}</strong> Â· Broker: ${b.name}`;

  // Render drivers
  const drivers = [
    {name:'Rajesh Kumar', vehicle:'Curtainsider 44t', location:'Birmingham'},
    {name:'Harpreet Singh', vehicle:'Refrigerated 20t', location:'Manchester'},
    {name:'David Jones', vehicle:'Box Van 3.5t', location:'Bristol'},
    {name:'Mohammed Ali', vehicle:'Flatbed 30t', location:'Leeds'},
    {name:'Colin Fraser', vehicle:'Tanker 28t', location:'Glasgow'},
  ];
  document.getElementById('driver-select').innerHTML = drivers.map((d,i)=>`
    <div class="driver-option" onclick="selectDriver(${i},this)">
      <div class="driver-name">${d.name}</div>
      <div class="driver-vehicle">${d.vehicle}</div>
      <div class="driver-location">ğŸ“ ${d.location}</div>
    </div>`).join('');

  selectedDriver = null;
  document.getElementById('f-collection').value = '';
  document.getElementById('f-delivery').value = '';
  document.getElementById('f-col-contact').value = '';
  document.getElementById('f-del-contact').value = '';
  document.getElementById('f-instructions').value = '';
  document.getElementById('booking-modal').classList.add('show');
}

function selectDriver(idx, el){
  document.querySelectorAll('.driver-option').forEach(d=>d.classList.remove('selected'));
  el.classList.add('selected');
  selectedDriver = idx;
}

function confirmBooking(){
  if(selectedDriver === null){
    showToast('âš ï¸','Please select a driver first','');
    return;
  }
  const col = document.getElementById('f-collection').value.trim();
  const del = document.getElementById('f-delivery').value.trim();
  if(!col || !del){
    showToast('âš ï¸','Please fill in collection and delivery addresses','');
    return;
  }
  closeModal('booking-modal');
  generateCN();
}

function generateCN(){
  const l = currentLoad;
  const b = BROKERS[l.broker];
  const drivers = [
    {name:'Rajesh Kumar', vehicle:'Curtainsider 44t', reg:'BG23 XKL'},
    {name:'Harpreet Singh', vehicle:'Refrigerated 20t', reg:'MN71 PLQ'},
    {name:'David Jones', vehicle:'Box Van 3.5t', reg:'YK19 CRV'},
    {name:'Mohammed Ali', vehicle:'Flatbed 30t', reg:'SH65 JWP'},
    {name:'Colin Fraser', vehicle:'Tanker 28t', reg:'LG70 KMR'},
  ];
  const driver = drivers[selectedDriver];
  const ref = 'EX-' + l.id + '-' + Date.now().toString().slice(-4);
  const col = document.getElementById('f-collection').value || l.from + ' Depot';
  const del = document.getElementById('f-delivery').value || l.to + ' Depot';
  const colContact = document.getElementById('f-col-contact').value || 'Contact on arrival';
  const delContact = document.getElementById('f-del-contact').value || 'Contact on arrival';
  const instructions = document.getElementById('f-instructions').value || 'Standard delivery â€” no special requirements';
  const today = new Date().toLocaleDateString('en-GB');

  document.getElementById('cn-ref').textContent = ref;
  document.getElementById('cn-body').innerHTML = `
    <div class="cn-grid">
      <div class="cn-field"><div class="cn-field-label">Date</div><div class="cn-field-value">${today}</div></div>
      <div class="cn-field"><div class="cn-field-label">Reference</div><div class="cn-field-value" style="font-family:'JetBrains Mono',monospace;font-size:12px">${ref}</div></div>
      <div class="cn-field"><div class="cn-field-label">Carrier / Haulier</div><div class="cn-field-value">Xeagle Ltd (on behalf of carrier)</div></div>
      <div class="cn-field"><div class="cn-field-label">Driver Name</div><div class="cn-field-value">${driver.name}</div></div>
      <div class="cn-field"><div class="cn-field-label">Vehicle Reg</div><div class="cn-field-value" style="font-family:'JetBrains Mono',monospace">${driver.reg}</div></div>
      <div class="cn-field"><div class="cn-field-label">Vehicle Type</div><div class="cn-field-value">${l.vehicle}</div></div>
      <div class="cn-field cn-full"><div class="cn-field-label">Collection Address</div><div class="cn-field-value">${col}</div></div>
      <div class="cn-field"><div class="cn-field-label">Collection Time</div><div class="cn-field-value">${l.col} â€” ${today}</div></div>
      <div class="cn-field"><div class="cn-field-label">Collection Contact</div><div class="cn-field-value">${colContact}</div></div>
      <div class="cn-field cn-full"><div class="cn-field-label">Delivery Address</div><div class="cn-field-value">${del}</div></div>
      <div class="cn-field"><div class="cn-field-label">Delivery Time</div><div class="cn-field-value">By ${l.del} â€” ${today}</div></div>
      <div class="cn-field"><div class="cn-field-label">Delivery Contact</div><div class="cn-field-value">${delContact}</div></div>
      <div class="cn-field"><div class="cn-field-label">Description of Goods</div><div class="cn-field-value">${l.goods}</div></div>
      <div class="cn-field"><div class="cn-field-label">Weight</div><div class="cn-field-value">${l.weight}</div></div>
      <div class="cn-field"><div class="cn-field-label">Distance</div><div class="cn-field-value">${l.miles} miles</div></div>
      <div class="cn-field"><div class="cn-field-label">Agreed Rate</div><div class="cn-field-value" style="font-family:'Syne',sans-serif;font-weight:800;font-size:16px;color:var(--navy)">Â£${negotiatedRate.toLocaleString()}</div></div>
      <div class="cn-field"><div class="cn-field-label">Load Poster</div><div class="cn-field-value">${b.name}</div></div>
      <div class="cn-field cn-full"><div class="cn-field-label">Special Instructions</div><div class="cn-field-value">${instructions}</div></div>
    </div>
    <div class="cn-stamp">
      <div class="cn-stamp-box">
        <div class="cn-stamp-label">Dispatcher Signature</div>
        <div class="cn-stamp-line">Dispatched by Xeagle Ltd</div>
      </div>
      <div class="cn-stamp-box">
        <div class="cn-stamp-label">Driver Signature</div>
        <div class="cn-stamp-line">${driver.name}</div>
      </div>
      <div class="cn-stamp-box">
        <div class="cn-stamp-label">Collected By (Shipper)</div>
        <div class="cn-stamp-line">Stamp &amp; Sign</div>
      </div>
    </div>
    <div style="background:rgba(43,43,168,0.06);border:1px solid var(--border);border-radius:var(--r-sm);padding:10px 14px;margin-top:16px;font-size:11px;color:var(--text3)">
      This is a training document generated by Eagle Exchange. In real operations, consignment notes are legally binding documents carried by the driver throughout the journey. For international loads a CMR Note would be used instead.
    </div>`;

  // Mark as booked
  bookedIds.push(l.id);
  localStorage.setItem('ex_booked', JSON.stringify(bookedIds));
  session.booked++;
  session.revenue += negotiatedRate;
  session.xp += 50;
  updateSessionBar();

  document.getElementById('st-booked').textContent = session.booked;
  document.getElementById('st-available').textContent = ALL_LOADS.length - bookedIds.length;

  renderLoadList();
  document.getElementById('cn-modal').classList.add('show');
  showToast('ğŸ“‹','Consignment note generated!','+50 XP for booking');
}

function refreshLoads(){
  // Simulate new loads appearing
  bookedIds = JSON.parse(localStorage.getItem('ex_booked') || '[]');
  applyFilters();
  showToast('â†»','Load board refreshed','New loads may be available');
}

function closeModal(id){
  document.getElementById(id).classList.remove('show');
}

function printCN(){
  window.print();
}

let toastTimeout;
function showToast(emoji, title, xp){
  const t = document.getElementById('score-toast');
  document.getElementById('toast-emoji').textContent = emoji;
  document.getElementById('toast-title').textContent = title;
  document.getElementById('toast-xp').textContent = xp;
  t.classList.add('show');
  clearTimeout(toastTimeout);
  toastTimeout = setTimeout(()=>t.classList.remove('show'), 3000);
}

// INIT
applyFilters();
updateSessionBar();

// Auto-refresh loads every 60 seconds (simulate live board)
setInterval(()=>{
  // Add subtle animation to urgent items
  document.querySelectorAll('.load-item.urgent').forEach(el=>{
    el.style.borderLeft = '3px solid var(--red)';
  });
}, 60000);
</script>
</body>
</html>
