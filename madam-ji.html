<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Madam JI â€” Eagle Academy AI Tutor</title>
<link rel="stylesheet" href="assets/style.css"/>
<style>
:root{
  --mj-purple:#7c3aed;
  --mj-purple2:#a78bfa;
  --mj-purple3:rgba(139,92,246,0.15);
  --mj-glow:rgba(139,92,246,0.35);
  --font-main:'DM Sans',sans-serif;
  --font-head:'Syne',sans-serif;
  --font-mono:'JetBrains Mono',monospace;
  --navy-dark:#03041a;
  --radius-md:12px;
  --radius-lg:18px;
  --radius-xl:24px;
}

/* â”€â”€ LAYOUT â”€â”€ */
.mj-layout{display:grid;grid-template-columns:300px 1fr;height:calc(100vh - 68px);overflow:hidden}
@media(max-width:768px){.mj-layout{grid-template-columns:1fr;height:auto}}

/* â”€â”€ SIDEBAR â”€â”€ */
.mj-sidebar{background:rgba(3,4,26,0.95);border-right:1px solid rgba(139,92,246,0.15);display:flex;flex-direction:column;overflow:hidden}
.mj-profile{padding:24px 20px;border-bottom:1px solid rgba(139,92,246,0.12);text-align:center}
.mj-avatar{width:80px;height:80px;border-radius:50%;background:linear-gradient(135deg,#7c3aed,#4f46e5,var(--orange));display:flex;align-items:center;justify-content:center;font-size:36px;margin:0 auto 12px;box-shadow:0 0 40px var(--mj-glow),0 0 80px rgba(139,92,246,0.15);animation:mjPulse 3s ease infinite}
@keyframes mjPulse{0%,100%{box-shadow:0 0 40px var(--mj-glow)}50%{box-shadow:0 0 60px rgba(139,92,246,0.6),0 0 100px rgba(139,92,246,0.2)}}
.mj-name{font-family:var(--font-head);font-size:18px;font-weight:900;margin-bottom:3px}
.mj-title{font-size:11px;color:var(--mj-purple2);font-family:var(--font-mono);letter-spacing:.5px;text-transform:uppercase}
.mj-status{display:inline-flex;align-items:center;gap:5px;font-size:11px;color:var(--green);margin-top:8px}
.mj-dot{width:7px;height:7px;border-radius:50%;background:var(--green);animation:blink 2s ease infinite}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.3}}
.mj-bio{font-size:12px;color:rgba(255,255,255,0.5);line-height:1.7;margin-top:10px;text-align:left}

.mj-topics{flex:1;overflow-y:auto;padding:12px 12px 0;scrollbar-width:thin;scrollbar-color:var(--mj-purple) transparent}
.mj-topics h4{font-size:10px;color:rgba(255,255,255,0.3);text-transform:uppercase;letter-spacing:1px;font-family:var(--font-mono);padding:8px 8px 4px}
.topic-chip{width:100%;padding:9px 12px;text-align:left;background:transparent;border:1px solid rgba(255,255,255,0.07);border-radius:10px;color:rgba(255,255,255,0.7);font-family:var(--font-main);font-size:12px;cursor:pointer;transition:all .2s;margin-bottom:5px;display:flex;align-items:center;gap:8px;line-height:1.4}
.topic-chip:hover{background:rgba(139,92,246,0.1);border-color:rgba(139,92,246,0.35);color:var(--white)}
.topic-chip .tc-icon{font-size:14px;flex-shrink:0}

.mj-api-section{padding:14px 12px;border-top:1px solid rgba(139,92,246,0.12)}
.api-label{font-size:10px;color:rgba(255,255,255,0.35);font-family:var(--font-mono);letter-spacing:.5px;text-transform:uppercase;margin-bottom:6px}
.api-input-wrap{display:flex;gap:6px;align-items:center}
.api-input{flex:1;padding:8px 10px;background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.1);border-radius:8px;color:var(--white);font-family:var(--font-mono);font-size:11px;outline:none;transition:border-color .2s}
.api-input:focus{border-color:var(--mj-purple2)}
.api-save{padding:7px 12px;background:rgba(139,92,246,0.2);border:1px solid rgba(139,92,246,0.35);border-radius:8px;color:var(--mj-purple2);font-size:11px;font-weight:700;cursor:pointer;font-family:var(--font-main);transition:all .2s;white-space:nowrap}
.api-save:hover{background:var(--mj-purple);color:white}
.api-status{font-size:10px;margin-top:5px}

/* â”€â”€ CHAT AREA â”€â”€ */
.mj-chat{display:flex;flex-direction:column;background:var(--navy-dark);overflow:hidden}
.chat-header{padding:16px 24px;border-bottom:1px solid rgba(139,92,246,0.12);display:flex;align-items:center;gap:12px;flex-shrink:0}
.chat-messages{flex:1;overflow-y:auto;padding:24px;scrollbar-width:thin;scrollbar-color:var(--mj-purple) transparent;display:flex;flex-direction:column;gap:18px}

/* MESSAGES */
.msg{display:flex;gap:10px;max-width:78%;animation:msgIn .3s ease}
@keyframes msgIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
.msg.user{align-self:flex-end;flex-direction:row-reverse}
.msg.assistant{align-self:flex-start}
.msg-avatar{width:34px;height:34px;border-radius:50%;flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:15px;margin-top:2px}
.msg.assistant .msg-avatar{background:linear-gradient(135deg,var(--mj-purple),#4f46e5)}
.msg.user .msg-avatar{background:linear-gradient(135deg,var(--orange),var(--orange-dark))}
.msg-bubble{padding:12px 16px;border-radius:18px;font-size:14px;line-height:1.75;position:relative}
.msg.assistant .msg-bubble{background:rgba(139,92,246,0.1);border:1px solid rgba(139,92,246,0.2);border-radius:4px 18px 18px 18px;color:rgba(255,255,255,0.9)}
.msg.user .msg-bubble{background:linear-gradient(135deg,rgba(249,115,22,0.2),rgba(234,108,10,0.15));border:1px solid rgba(249,115,22,0.25);border-radius:18px 4px 18px 18px;color:var(--white)}
.msg-bubble strong{color:var(--mj-purple2)}
.msg-bubble code{background:rgba(0,0,0,0.3);padding:2px 6px;border-radius:4px;font-family:var(--font-mono);font-size:12px;color:var(--cyan)}
.msg-bubble ul{padding-left:16px;margin:6px 0}
.msg-bubble li{margin-bottom:3px}
.msg-bubble .tag-inline{display:inline-block;background:rgba(34,197,94,0.15);border:1px solid rgba(34,197,94,0.3);color:var(--green);border-radius:99px;padding:1px 8px;font-size:11px;font-family:var(--font-mono);font-weight:700;margin:1px 2px}
.msg-time{font-size:10px;color:rgba(255,255,255,0.25);margin-top:5px;text-align:right}
.msg.assistant .msg-time{text-align:left}
.msg-tts{background:none;border:none;cursor:pointer;font-size:14px;opacity:.5;transition:opacity .2s;padding:2px 4px;margin-top:3px}
.msg-tts:hover{opacity:1}

/* TYPING INDICATOR */
.typing-indicator{display:flex;align-items:center;gap:5px;padding:14px 16px;background:rgba(139,92,246,0.08);border:1px solid rgba(139,92,246,0.15);border-radius:4px 18px 18px 18px;align-self:flex-start}
.typing-dot{width:7px;height:7px;border-radius:50%;background:var(--mj-purple2);animation:typingBounce 1.4s ease infinite}
.typing-dot:nth-child(2){animation-delay:.2s}
.typing-dot:nth-child(3){animation-delay:.4s}
@keyframes typingBounce{0%,60%,100%{transform:translateY(0);opacity:.4}30%{transform:translateY(-8px);opacity:1}}

/* QUICK REPLIES */
.quick-replies{padding:10px 24px 0;display:flex;flex-wrap:wrap;gap:7px;flex-shrink:0}
.qr-chip{padding:7px 14px;background:rgba(139,92,246,0.08);border:1px solid rgba(139,92,246,0.25);border-radius:99px;color:var(--mj-purple2);font-size:12px;font-weight:600;cursor:pointer;font-family:var(--font-main);transition:all .2s;white-space:nowrap}
.qr-chip:hover{background:rgba(139,92,246,0.2);border-color:var(--mj-purple2);color:var(--white);transform:translateY(-1px)}

/* INPUT AREA */
.chat-input-area{padding:16px 24px;border-top:1px solid rgba(139,92,246,0.12);flex-shrink:0}
.chat-input-row{display:flex;gap:10px;align-items:flex-end}
.chat-textarea{flex:1;padding:12px 16px;background:rgba(255,255,255,0.05);border:1px solid rgba(139,92,246,0.25);border-radius:var(--radius-lg);color:var(--white);font-family:var(--font-main);font-size:14px;outline:none;resize:none;min-height:46px;max-height:120px;line-height:1.5;transition:border-color .2s}
.chat-textarea:focus{border-color:var(--mj-purple2);background:rgba(255,255,255,0.07)}
.chat-textarea::placeholder{color:rgba(255,255,255,0.25)}
.send-btn{width:46px;height:46px;border-radius:14px;background:linear-gradient(135deg,var(--mj-purple),#4f46e5);border:none;color:white;font-size:18px;cursor:pointer;transition:all .2s;flex-shrink:0;display:flex;align-items:center;justify-content:center}
.send-btn:hover{filter:brightness(1.15);transform:translateY(-1px);box-shadow:0 6px 20px var(--mj-glow)}
.send-btn:disabled{opacity:.4;cursor:default;transform:none}
.lang-row{display:flex;align-items:center;gap:8px;margin-top:8px;flex-wrap:wrap}
.lang-row span{font-size:11px;color:rgba(255,255,255,0.3)}
.mode-chip{padding:4px 11px;background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.1);border-radius:99px;color:rgba(255,255,255,0.5);font-size:11px;font-weight:600;cursor:pointer;font-family:var(--font-main);transition:all .2s}
.mode-chip.act{background:rgba(139,92,246,0.15);border-color:var(--mj-purple2);color:var(--mj-purple2)}

/* WELCOME CARD */
.welcome-card{max-width:560px;margin:auto;text-align:center;padding:24px}
.welcome-icon{font-size:64px;margin-bottom:16px;display:inline-block;animation:float 3s ease infinite}
@keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-8px)}}

/* MOBILE */
@media(max-width:768px){
  .mj-sidebar{display:none}
  .mj-layout{height:auto;min-height:calc(100vh - 68px)}
  .mj-chat{height:calc(100vh - 68px)}
  .msg{max-width:88%}
}
</style>
</head>
<body>

<header class="ea-header">
  <div class="ea-header-inner">
    <a href="index.html" class="ea-logo">
      <img src="assets/logo.png" alt="Eagle Academy" onerror="this.style.display='none'"/>
      <div class="ea-logo-text"><div class="brand">EAGLE ACADEMY</div><div class="sub">Freight Dispatcher Certification</div></div>
    </a>
    <nav class="ea-nav">
      <a href="index.html" class="ea-nav-btn">ğŸ  Home</a>
      <a href="week1.html" class="ea-nav-btn">Week 1</a>
      <a href="week2.html" class="ea-nav-btn">Week 2</a>
      <a href="week3.html" class="ea-nav-btn">Week 3</a>
      <a href="week4.html" class="ea-nav-btn">Week 4</a>
      <a href="tools.html" class="ea-nav-btn">ğŸ§® Tools</a>
      <a href="madam-ji.html" class="ea-nav-btn active">ğŸ“ Madam JI</a>
      <a href="exam.html" class="ea-nav-btn">ğŸ“ Final Exam</a>
    </nav>
    <div class="lang-toggle">
      <button class="lang-btn active" id="gl_en" onclick="setGlobalLang('en',this)">EN</button>
      <button class="lang-btn" id="gl_hi" onclick="setGlobalLang('hi',this)">à¤¹à¤¿à¤‚</button>
    </div>
  </div>
</header>

<div class="mj-layout">

  <!-- â•â• SIDEBAR â•â• -->
  <aside class="mj-sidebar">
    <!-- Profile -->
    <div class="mj-profile">
      <div class="mj-avatar">ğŸ“</div>
      <div class="mj-name">Madam JI</div>
      <div class="mj-title">AI Freight Dispatch Tutor</div>
      <div class="mj-status"><span class="mj-dot"></span> Online â€” Ready to help</div>
      <div class="mj-bio">Expert in UK transport law, DVSA compliance, drivers' hours, CMR, Courier Exchange, and pallet networks. Ask me anything â€” in English or Hindi!</div>
    </div>

    <!-- Topic Suggestions -->
    <div class="mj-topics">
      <h4>ğŸ‡¬ğŸ‡§ UK Topics</h4>
      <button class="topic-chip" onclick="sendQuick('What are the 3 types of UK Operator Licence and when do you need each one?')"><span class="tc-icon">ğŸ“‹</span>UK O-Licence types explained</button>
      <button class="topic-chip" onclick="sendQuick('Explain UK drivers hours rules â€” the 4.5hr rule, daily max, weekly max, and tachograph modes D H A X')"><span class="tc-icon">â±</span>UK Drivers' Hours &amp; Tachograph</button>
      <button class="topic-chip" onclick="sendQuick('What is a CMR Note? When is it required? How many originals? What is the liability cap?')"><span class="tc-icon">ğŸ“„</span>CMR Note â€” what, when, how</button>
      <button class="topic-chip" onclick="sendQuick('Tell me about Courier Exchange â€” how it works, cost, how to use it as a dispatcher, and how it compares to DAT in the USA')"><span class="tc-icon">ğŸ”—</span>Courier Exchange vs DAT</button>
      <button class="topic-chip" onclick="sendQuick('Explain how UK pallet networks work â€” Palletforce, Pall-Ex, TPN â€” collection, trunking, hub, delivery, and income potential')"><span class="tc-icon">ğŸ“¦</span>Pallet Networks explained</button>
      <button class="topic-chip" onclick="sendQuick('How do I verify a UK carrier has a valid Operator Licence before dispatching them?')"><span class="tc-icon">âœ…</span>Verify UK carrier O-Licence</button>
      <h4>ğŸ’¼ Dispatch Operations</h4>
      <button class="topic-chip" onclick="sendQuick('Teach me the ICAR method for broker calls â€” step by step with an example')"><span class="tc-icon">ğŸ“</span>ICAR broker call method</button>
      <button class="topic-chip" onclick="sendQuick('How do I handle detention pay? When does it start, how do I document it, and how do I claim it?')"><span class="tc-icon">ğŸ•</span>Detention pay â€” how to handle</button>
      <button class="topic-chip" onclick="sendQuick('What documents make up a complete carrier packet and what does each one do?')"><span class="tc-icon">ğŸ“</span>Carrier packet documents</button>
      <button class="topic-chip" onclick="sendQuick('What are the most important KPIs for a UK freight dispatcher and what are the target numbers?')"><span class="tc-icon">ğŸ“Š</span>UK Dispatcher KPIs</button>
      <h4>ğŸš€ Career &amp; Business</h4>
      <button class="topic-chip" onclick="sendQuick('How do I find UK owner-operator carriers to sign as my clients? Give me a cold call script and where to find them')"><span class="tc-icon">ğŸ¤</span>Finding UK carriers to sign</button>
      <button class="topic-chip" onclick="sendQuick('What is the India-UK time zone advantage for dispatching? Show me the GMT-IST conversion and daily schedule')"><span class="tc-icon">ğŸŒ</span>India â†” UK time zone strategy</button>
      <button class="topic-chip" onclick="sendQuick('What keywords must I put on my UK dispatcher CV and LinkedIn to get noticed by UK transport companies?')"><span class="tc-icon">ğŸ“</span>UK CV &amp; LinkedIn keywords</button>
      <button class="topic-chip" onclick="sendQuick('Give me model answers for these UK dispatcher interview questions: O-Licence, drivers hours, CMR note, minimum rate')"><span class="tc-icon">ğŸ¯</span>UK interview prep</button>
    </div>

    <!-- API Key -->
    <div class="mj-api-section">
      <div class="api-label">ğŸ”‘ Anthropic API Key</div>
      <div class="api-input-wrap">
        <input type="password" class="api-input" id="api_key_input" placeholder="sk-ant-api03-â€¦"/>
        <button class="api-save" onclick="saveKey()">Save</button>
      </div>
      <div class="api-status" id="api_status"></div>
      <div style="font-size:10px;color:rgba(255,255,255,0.2);margin-top:5px;line-height:1.5">Key saved in browser only. Never shared. Instructor: get key at console.anthropic.com</div>
    </div>
  </aside>

  <!-- â•â• CHAT â•â• -->
  <section class="mj-chat" id="chat_section">

    <!-- Chat header bar -->
    <div class="chat-header">
      <div style="width:36px;height:36px;border-radius:50%;background:linear-gradient(135deg,var(--mj-purple),#4f46e5);display:flex;align-items:center;justify-content:center;font-size:16px;box-shadow:0 0 16px var(--mj-glow)">ğŸ“</div>
      <div>
        <div style="font-family:var(--font-head);font-size:15px;font-weight:800">Madam JI</div>
        <div style="font-size:11px;color:var(--green);display:flex;align-items:center;gap:4px"><span class="mj-dot" style="width:5px;height:5px"></span>UK Freight Dispatch Expert Â· AI Powered</div>
      </div>
      <div style="margin-left:auto;display:flex;gap:8px">
        <button onclick="clearChat()" style="padding:6px 14px;background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.25);border-radius:8px;color:var(--red);font-size:12px;font-weight:600;cursor:pointer;font-family:var(--font-main);transition:all .2s" title="Clear chat">ğŸ—‘ Clear</button>
        <button onclick="toggleVoice()" id="voice_btn" style="padding:6px 14px;background:rgba(139,92,246,0.1);border:1px solid rgba(139,92,246,0.25);border-radius:8px;color:var(--mj-purple2);font-size:12px;font-weight:600;cursor:pointer;font-family:var(--font-main);transition:all .2s" title="Toggle voice">ğŸ”‡ Voice</button>
      </div>
    </div>

    <!-- Messages -->
    <div class="chat-messages" id="chat_messages">
      <!-- Welcome card shown before first message -->
      <div class="welcome-card" id="welcome_card">
        <div class="welcome-icon">ğŸ“</div>
        <h2 style="font-family:var(--font-head);font-size:24px;font-weight:900;margin-bottom:8px">Namaste! I'm Madam JI</h2>
        <p style="font-size:14px;color:rgba(255,255,255,0.6);line-height:1.8;margin-bottom:6px">Your AI tutor for Eagle Academy's <strong style="color:var(--white)">UK Freight Dispatcher Certification</strong>. Ask me anything â€” UK transport law, DVSA rules, drivers' hours, CMR, Courier Exchange, pallet networks, career advice, or practice interview questions.</p>
        <p style="font-size:13px;color:var(--mj-purple2);font-family:var(--font-mono)">English Â· à¤¹à¤¿à¤‚à¤¦à¥€ Â· Both!</p>
        <div style="margin-top:20px;display:flex;flex-wrap:wrap;gap:8px;justify-content:center">
          <span style="padding:5px 13px;background:rgba(34,197,94,0.1);border:1px solid rgba(34,197,94,0.3);border-radius:99px;font-size:11px;color:var(--green);font-family:var(--font-mono)">ğŸ‡¬ğŸ‡§ UK Focus</span>
          <span style="padding:5px 13px;background:rgba(139,92,246,0.1);border:1px solid rgba(139,92,246,0.3);border-radius:99px;font-size:11px;color:var(--mj-purple2);font-family:var(--font-mono)">AI Powered</span>
          <span style="padding:5px 13px;background:rgba(249,115,22,0.1);border:1px solid rgba(249,115,22,0.3);border-radius:99px;font-size:11px;color:var(--orange);font-family:var(--font-mono)">ğŸ‡®ğŸ‡³ Bilingual</span>
          <span style="padding:5px 13px;background:rgba(6,182,212,0.1);border:1px solid rgba(6,182,212,0.3);border-radius:99px;font-size:11px;color:var(--cyan);font-family:var(--font-mono)">24/7 Ready</span>
        </div>
        <div style="margin-top:20px;padding:14px 18px;background:rgba(255,200,50,0.06);border:1px solid rgba(255,200,50,0.15);border-radius:12px;font-size:12px;color:rgba(255,255,255,0.5);text-align:left;line-height:1.8">
          <strong style="color:rgba(255,200,50,0.8)">ğŸ“Œ Instructor Setup:</strong> Enter your Anthropic API key in the sidebar to activate AI responses. Get your key at <code style="font-family:var(--font-mono);color:var(--cyan)">console.anthropic.com</code> â†’ API Keys. Without it, Madam JI will use built-in responses.
        </div>
      </div>
    </div>

    <!-- Quick reply chips -->
    <div class="quick-replies" id="quick_replies">
      <button class="qr-chip" onclick="sendQuick('What is an O-Licence and who needs one?')">ğŸ‡¬ğŸ‡§ O-Licence</button>
      <button class="qr-chip" onclick="sendQuick('Explain the UK 4.5 hour driving rule')">â± 4.5hr Rule</button>
      <button class="qr-chip" onclick="sendQuick('What is a CMR Note?')">ğŸ“„ CMR Note</button>
      <button class="qr-chip" onclick="sendQuick('How does Courier Exchange work?')">ğŸ”— Courier Exchange</button>
      <button class="qr-chip" onclick="sendQuick('What is the India-UK time zone difference and why is it good for dispatching?')">ğŸŒ Time Zones</button>
      <button class="qr-chip" onclick="sendQuick('Mujhe Hindi mein batao: UK dispatcher kaise bane?')">ğŸ‡®ğŸ‡³ Hindi mein</button>
      <button class="qr-chip" onclick="sendQuick('Give me 5 quick exam revision tips for the Eagle Academy final exam')">ğŸ“ Exam Tips</button>
    </div>

    <!-- Input -->
    <div class="chat-input-area">
      <div class="chat-input-row">
        <textarea class="chat-textarea" id="chat_input" placeholder="Ask Madam JI anything about UK freight dispatchâ€¦" rows="1"
          onkeydown="handleKey(event)" oninput="autoResize(this)"></textarea>
        <button class="send-btn" id="send_btn" onclick="sendMessage()" title="Send">â–¶</button>
      </div>
      <div class="lang-row">
        <span>Mode:</span>
        <button class="mode-chip act" id="mode_en" onclick="setMode('english',this)">ğŸ‡¬ğŸ‡§ English</button>
        <button class="mode-chip" id="mode_hi" onclick="setMode('hindi',this)">ğŸ‡®ğŸ‡³ Hindi</button>
        <button class="mode-chip" id="mode_bi" onclick="setMode('bilingual',this)">ğŸ”€ Bilingual</button>
        <span style="margin-left:auto;font-size:11px;color:rgba(255,255,255,0.2)" id="char_count"></span>
      </div>
    </div>

  </section>
</div>

<script src="assets/app.js"></script>
<script>
// â”€â”€ STATE â”€â”€
let conversationHistory = [];
let apiKey = '';
let responseMode = 'english';
let voiceEnabled = false;
let synth = window.speechSynthesis;

// â”€â”€ SYSTEM PROMPT â”€â”€
const SYSTEM_PROMPT = `You are Madam JI, the expert AI tutor for Eagle Academy's International Freight Dispatcher Certification programme. You are warm, encouraging, highly knowledgeable, and structured in your teaching style.

YOUR EXPERTISE (PRIMARY â€” UK FOCUS):
- UK Operator's Licence (O-Licence): Restricted, Standard National, Standard International; Traffic Commissioner; DVSA; financial standing requirements; operating centre requirements; verification at vehicle-operator-licensing.service.gov.uk
- UK Drivers' Hours Rules: 9hr daily max (10hr twice/week), 4.5hr continuous driving â†’ 45min break (15+30 split allowed), 11hr daily rest (9hr reduced max 3Ã—/week), 56hr weekly max, 90hr fortnightly max, weekly 45hr rest
- Tachograph: D (driving), H (other work), A (availability), X (rest); dispatcher legal responsibility
- CMR Notes: required for all international road freight; 3 originals; 8.33 SDR/kg liability cap; vs UK consignment note for domestic
- Post-Brexit: EORI numbers, customs declarations, T1/T2 transit documents
- Courier Exchange (CX): UK's largest freight exchange, 6000+ members, Â£120-200/month, credit ratings, vs DAT in USA
- UK load boards: Haulage Exchange (TEG), Direct Freight, WhatsApp groups
- Major UK logistics: DHL Supply Chain UK (largest 3PL), XPO, Wincanton, GXO, Eddie Stobart (2000+ vehicles, subcontractors), Kuehne+Nagel UK
- UK Pallet Networks: Palletforce (Eddie Stobart owned), Pall-Ex, TPN, Palletways; how collection/trunking/hub/delivery works; income Â£3,000-12,000/month for 1-2 vehicles
- UK HGV rates: Â£1.50-5.00/mile; FTL Â£600-2,500; pallets Â£20-80
- UK KPIs: OTP >95%, empty running <15% (industry avg 25-30%), CPM Â£1.20-1.80, RPM target >Â£2.50, vehicle utilisation >85%
- Time zones: IST is UTC+5:30, UK GMT is UTC+0 (BST UTC+1 in summer). UK 8AM = India 1:30PM â€” a major lifestyle advantage vs US dispatching where night shifts are needed
- UK carrier acquisition: Facebook groups "UK Owner Operators", "HGV Owner Drivers UK", transport cafÃ©s (Keele, Thurrock, Cobham), industrial estates near ports
- UK CV: no photo, no DOB, British spellings (licence not license), ATS keywords: DVSA, O-Licence, CMR, Courier Exchange, tachograph
- LinkedIn: headline must include UK Freight Dispatcher | DVSA | CMR | Courier Exchange | Remote
- UK job boards: Totaljobs.com, CV-Library.co.uk, Reed.co.uk, Indeed.co.uk
- UK dispatcher salary: entry Â£24-32k, experienced Â£32-45k; self-employed India 10 vehicles = Â£9,600-14,400/year commission = â‚¹10-15 lakh/month
- UK subcontractor requirements: O-Licence + Â£5M liability + compliance audit

YOUR SECONDARY EXPERTISE (USA):
- FMCSA, MC numbers, HOS (11hr driving, 14hr window, 30min break after 8hrs, 70hr/8-day)
- Load boards: DAT, Truckstop.com
- Documents: BOL, POD, Rate Confirmation, W-9, COI, carrier packet
- Trailer types: Dry Van, Reefer, Flatbed, Step Deck, Curtainsider (UK)
- Factoring, detention (2 free hours, then charge), TONU
- ICAR method: Introduce, Confirm load details, Ask for rate (never give first), Rate negotiation

TEACHING STYLE:
- Always structured: use numbered lists, bold key terms, practical examples
- Reference specific UK regulations by number/name when relevant
- Give memory aids and mnemonics when useful
- Connect theory to real dispatcher practice: "In practice, this means..."
- Use encouraging language: "Great question!", "You'll definitely see this in the exam..."
- Always end with a follow-up suggestion: "Want me to quiz you on this?" or "Should I give you a practice scenario?"

RESPONSE FORMAT by mode:
- English mode: Respond fully in English with clear structure
- Hindi mode: Respond in Hindi (Devanagari script) with key technical terms in English in brackets
- Bilingual mode: Give the main explanation in English, then a short Hindi summary at the end marked with ğŸ‡®ğŸ‡³

Keep responses focused and useful. If asked something outside freight dispatch training, gently redirect: "I'm best at UK freight dispatch topics â€” let me help you with that instead!"`;

// â”€â”€ API KEY â”€â”€
function saveKey() {
  const k = document.getElementById('api_key_input').value.trim();
  if (!k) return;
  apiKey = k;
  try { localStorage.setItem('ea_api_key', k); } catch(e) {}
  const st = document.getElementById('api_status');
  st.style.color = 'var(--green)';
  st.textContent = 'âœ… Key saved â€” Madam JI is live!';
  document.getElementById('api_key_input').value = 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢';
  setTimeout(() => { if(st.textContent.startsWith('âœ…')) st.textContent = ''; }, 4000);
}

function loadKey() {
  try {
    const k = localStorage.getItem('ea_api_key');
    if (k) { apiKey = k; document.getElementById('api_status').style.color='var(--green)'; document.getElementById('api_status').textContent = 'âœ… API key loaded'; setTimeout(()=>{document.getElementById('api_status').textContent='';},3000); }
  } catch(e) {}
}

// â”€â”€ MODES â”€â”€
function setMode(mode, btn) {
  responseMode = mode;
  document.querySelectorAll('.mode-chip').forEach(b => b.classList.remove('act'));
  btn.classList.add('act');
}
function setGlobalLang(l, btn) {
  document.querySelectorAll('.lang-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  if (l === 'hi') setMode('hindi', document.getElementById('mode_hi'));
  else setMode('english', document.getElementById('mode_en'));
}

// â”€â”€ VOICE â”€â”€
function toggleVoice() {
  voiceEnabled = !voiceEnabled;
  const btn = document.getElementById('voice_btn');
  btn.textContent = voiceEnabled ? 'ğŸ”Š Voice ON' : 'ğŸ”‡ Voice';
  btn.style.background = voiceEnabled ? 'rgba(139,92,246,0.25)' : 'rgba(139,92,246,0.1)';
  btn.style.color = voiceEnabled ? 'var(--white)' : 'var(--mj-purple2)';
  if (!voiceEnabled && synth) synth.cancel();
}

function speakText(text) {
  if (!voiceEnabled || !synth) return;
  synth.cancel();
  const clean = text.replace(/[*_`#]/g, '').replace(/\n+/g, '. ').trim();
  const u = new SpeechSynthesisUtterance(clean);
  u.lang = responseMode === 'hindi' ? 'hi-IN' : 'en-GB';
  u.rate = 0.9;
  const voices = synth.getVoices();
  const match = voices.find(v => v.lang.startsWith(responseMode === 'hindi' ? 'hi' : 'en-GB'));
  if (match) u.voice = match;
  synth.speak(u);
}

// â”€â”€ CHAT â”€â”€
function autoResize(el) {
  el.style.height = 'auto';
  el.style.height = Math.min(el.scrollHeight, 120) + 'px';
  const len = el.value.length;
  document.getElementById('char_count').textContent = len > 0 ? len + ' chars' : '';
}

function handleKey(e) {
  if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
}

function sendQuick(text) {
  document.getElementById('chat_input').value = text;
  sendMessage();
}

function scrollBottom() {
  const c = document.getElementById('chat_messages');
  c.scrollTop = c.scrollHeight;
}

function fmt12(d) {
  let h = d.getHours(), m = d.getMinutes();
  const ampm = h >= 12 ? 'PM' : 'AM';
  h = h % 12 || 12;
  return h + ':' + String(m).padStart(2, '0') + ' ' + ampm;
}

function addMessage(role, content, animate = true) {
  const wc = document.getElementById('welcome_card');
  if (wc) wc.remove();
  const qr = document.getElementById('quick_replies');
  if (qr && role === 'user') qr.style.display = 'none';

  const container = document.getElementById('chat_messages');
  const div = document.createElement('div');
  div.className = 'msg ' + role;
  if (!animate) div.style.animation = 'none';

  const avatarIcon = role === 'assistant' ? 'ğŸ“' : 'ğŸ‘¤';
  const formattedContent = formatContent(content);
  const time = fmt12(new Date());

  div.innerHTML = `
    <div class="msg-avatar">${avatarIcon}</div>
    <div>
      <div class="msg-bubble">${formattedContent}</div>
      <div class="msg-time">${time}${role === 'assistant' ? ' <button class="msg-tts" onclick="speakText(this.dataset.text)" data-text="${escHtml(content)}" title="Read aloud">ğŸ”Š</button>' : ''}</div>
    </div>`;
  container.appendChild(div);
  scrollBottom();
  return div;
}

function escHtml(s) {
  return s.replace(/"/g, '&quot;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
}

function formatContent(text) {
  // Bold **text**
  text = text.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
  // Inline code `code`
  text = text.replace(/`(.+?)`/g, '<code>$1</code>');
  // Headers ## â†’ styled
  text = text.replace(/^#{1,3}\s+(.+)$/gm, '<div style="font-family:var(--font-head);font-size:15px;font-weight:800;color:var(--mj-purple2);margin:10px 0 4px">$1</div>');
  // Horizontal rule ---
  text = text.replace(/^---+$/gm, '<hr style="border:none;border-top:1px solid rgba(139,92,246,0.2);margin:10px 0"/>');
  // Numbered lists
  text = text.replace(/^(\d+)\.\s+(.+)$/gm, '<div style="display:flex;gap:8px;margin:3px 0"><span style="color:var(--mj-purple2);font-weight:700;min-width:18px;font-family:var(--font-mono);font-size:12px">$1.</span><span>$2</span></div>');
  // Bullet lists
  text = text.replace(/^[\-\â€¢]\s+(.+)$/gm, '<div style="display:flex;gap:8px;margin:2px 0"><span style="color:var(--mj-purple2);font-size:10px;margin-top:5px">â—</span><span>$1</span></div>');
  // Checkmarks âœ… lines
  text = text.replace(/^(âœ…|ğŸ”´|ğŸŸ¡|ğŸŸ¢|âš ï¸|ğŸ“‹|ğŸ¯|ğŸ’¡|ğŸ‡¬ğŸ‡§|ğŸ‡®ğŸ‡³|ğŸ“Œ)\s+(.+)$/gm, '<div style="display:flex;gap:8px;margin:3px 0;align-items:flex-start"><span style="font-size:14px;flex-shrink:0">$1</span><span>$2</span></div>');
  // Hindi summary block
  text = text.replace(/ğŸ‡®ğŸ‡³\s*\*\*(.+?)\*\*/g, '<div style="background:rgba(255,180,50,0.06);border-left:3px solid var(--gold);border-radius:0 8px 8px 0;padding:10px 12px;margin:10px 0;font-family:var(--font-hindi,sans-serif);font-size:13px;color:rgba(255,220,100,0.9)"><strong style="color:var(--gold);font-size:11px;font-family:var(--font-mono);letter-spacing:.5px;text-transform:uppercase">à¤¹à¤¿à¤‚à¤¦à¥€ à¤¸à¤¾à¤°à¤¾à¤‚à¤¶</strong><br/>$1</div>');
  // Newlines â†’ breaks (but not inside divs)
  text = text.replace(/\n\n/g, '<br/><br/>').replace(/\n/g, '<br/>');
  return text;
}

function showTyping() {
  const wc = document.getElementById('welcome_card');
  if (wc) wc.remove();
  const container = document.getElementById('chat_messages');
  const div = document.createElement('div');
  div.id = 'typing_indicator';
  div.style.cssText = 'display:flex;gap:10px;align-items:flex-start';
  div.innerHTML = `<div class="msg-avatar" style="width:34px;height:34px;border-radius:50%;background:linear-gradient(135deg,var(--mj-purple),#4f46e5);display:flex;align-items:center;justify-content:center;font-size:15px;flex-shrink:0">ğŸ“</div><div class="typing-indicator"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div>`;
  container.appendChild(div);
  scrollBottom();
}

function hideTyping() {
  const t = document.getElementById('typing_indicator');
  if (t) t.remove();
}

// â”€â”€ FALLBACK RESPONSES (when no API key) â”€â”€
const FALLBACKS = {
  'o-licence': `**UK Operator's Licence (O-Licence)**\n\nEvery HGV operator must hold one. There are 3 types:\n\n1. **Restricted** â€” carry only your own goods, not for hire\n2. **Standard National** â€” carry goods for hire within UK only\n3. **Standard International** â€” carry for hire UK + cross-border (EU/global)\n\n**Who issues it?** The Traffic Commissioner, regulated by DVSA.\n\n**Financial standing:** Â£8,000 for first vehicle + Â£4,500 each additional.\n\n**Verify a carrier's licence at:** vehicle-operator-licensing.service.gov.uk\n\nğŸ’¡ As a dispatcher, always verify your carrier's O-Licence is active and the correct type for the load BEFORE dispatching!\n\nWant me to quiz you on O-Licence types?`,
  'drivers hours|tachograph|4.5': `**UK Drivers' Hours Rules (EU Regulations)**\n\n**Daily Driving:**\n- Maximum 9 hours/day\n- Can extend to 10 hours TWICE per week\n- After **4.5 hours** continuous driving â†’ mandatory 45-min break\n- Break can split: 15 min first, then 30 min (must be in this order)\n\n**Weekly Limits:**\n- 56 hours maximum per week\n- 90 hours maximum per fortnight\n- 45 hours weekly rest required\n\n**Tachograph Modes:**\n- **D** â€” Driving ğŸš›\n- **H** â€” Other Work (loading, paperwork)\n- **A** â€” Availability (waiting at ferry, unsure when work starts)\n- **X** â€” Rest ğŸ˜´\n\n**Dispatcher Rule:** Never instruct a driver to exceed hours. Always check available hours before booking a load!\n\nShall I give you a practice planning scenario?`,
  'cmr': `**CMR Note â€” International Freight Document**\n\n**What is it?** The legally required document for all international road freight movements under the Convention on the Contract for the International Carriage of Goods by Road.\n\n**When required?** Any load crossing national borders â€” including UK-EU post-Brexit.\n\n**How many originals?** Minimum **3 originals:**\n1. Sender keeps one\n2. Travels with the goods (consignee receives)\n3. Carrier keeps one\n\n**Liability cap:** 8.33 SDR per kg of gross weight\n\n**For UK domestic loads:** Use a **Consignment Note** (delivery note) instead â€” simpler.\n\n**Post-Brexit additions:** EORI number + customs declarations required for UK-EU.\n\nWant to know the difference between CMR and a Bill of Lading?`,
  'time zone|ist|gmt|india': `**India â†” UK Time Zone Advantage ğŸ‡®ğŸ‡³ğŸ‡¬ğŸ‡§**\n\n**The conversion:**\n- UK (GMT) = IST **minus 5 hours 30 minutes**\n- UK 8:00 AM = India **1:30 PM** âœ…\n- UK 6:00 PM = India **11:30 PM** âœ…\n\n**Why UK dispatch is BETTER than USA for Indian dispatchers:**\n\n| | UK | USA East | USA West |\n|---|---|---|---|\n| Their 8 AM = India | 1:30 PM | 6:30 PM | 9:30 PM |\n| Work hours | Normal day | Evening | Night |\n\n**Daily India-based UK schedule:**\n- 9 AM IST â€” Search Courier Exchange\n- 1:30 PM IST â€” UK peak broker time\n- 6 PM IST â€” Evening check-calls\n- 11:30 PM IST â€” End of UK business day\n\nNo night shifts! This is a massive lifestyle advantage. Want to know more about the dispatch daily schedule?`,
  'commission|earn|salary|income': `**Dispatcher Commission Calculator ğŸ’°**\n\n**Standard UK commission rate:** 7-10% (typical: 8%)\n\n**Example calculation (1 vehicle):**\n- Avg load rate: Â£1,200\n- 4 loads per week\n- 8% commission\n- = Â£96 per load Ã— 4 Ã— 4 weeks = **Â£1,536/month**\n\n**Scaling up:**\n- 3 vehicles = Â£4,608/month\n- 5 vehicles = Â£7,680/month\n- **10 vehicles = Â£15,360/month** ğŸš€\n\n**In Indian Rupees (approx at Â£1 = â‚¹107):**\n- 10 vehicles = â‚¹16+ lakh/month\n\n**Monthly costs from India:** ~Â£350-500 (UK number, CX membership, internet)\n\nUse the ğŸ§® Tools page for the live commission calculator!`,
  'courier exchange|cx': `**Courier Exchange (CX) â€” UK's Load Board**\n\nCourier Exchange is the UK equivalent of DAT in the USA.\n\n**Key facts:**\n- 6,000+ members\n- UK's largest freight exchange\n- Real-time load posting and searching\n- Credit ratings for members (like DAT scores)\n- Mobile app available\n- **Cost:** Â£120-200/month\n\n**How to use as dispatcher:**\n1. Search loads by postcode, vehicle type, date\n2. Check member's credit rating before accepting\n3. Post your carrier's available vehicle\n4. Negotiate rate (aim for Â£2.50+/mile)\n5. Confirm booking, prepare consignment note\n\n**UK rate benchmarks:**\n- Pallet: Â£20-80\n- FTL curtainsider: Â£600-2,500\n- Per mile: Â£1.50-5.00\n\nOther UK boards: Haulage Exchange (TEG), Direct Freight. Want to know how to negotiate on CX?`,
  default: `I'm Madam JI, your UK freight dispatch tutor! I'm ready to help with:\n\nğŸ‡¬ğŸ‡§ **UK Topics:** O-Licence, DVSA rules, drivers' hours, tachograph, CMR Notes, Courier Exchange, pallet networks (Palletforce, Pall-Ex, TPN)\n\nğŸ‡ºğŸ‡¸ **USA Topics:** HOS, FMCSA, DAT, BOL, carrier packets, rate negotiation\n\nğŸ’¼ **Career:** UK CV, LinkedIn, interview prep, commission calculations, client acquisition\n\nFor **AI-powered answers**, enter your Anthropic API key in the sidebar.\n\nOr tap one of the topic buttons on the left to get started! What would you like to learn?`
};

function getFallback(question) {
  const q = question.toLowerCase();
  for (const [pattern, answer] of Object.entries(FALLBACKS)) {
    if (pattern === 'default') continue;
    if (pattern.split('|').some(p => q.includes(p))) return answer;
  }
  return FALLBACKS.default;
}

// â”€â”€ SEND MESSAGE â”€â”€
async function sendMessage() {
  const input = document.getElementById('chat_input');
  const text = input.value.trim();
  if (!text) return;

  input.value = '';
  input.style.height = 'auto';
  document.getElementById('char_count').textContent = '';

  // Add user message
  addMessage('user', text);
  conversationHistory.push({ role: 'user', content: text });

  // Show typing
  document.getElementById('send_btn').disabled = true;
  showTyping();

  // Build mode instruction
  const modeInstr = responseMode === 'hindi'
    ? ' [IMPORTANT: Respond entirely in Hindi (Devanagari script). Keep technical terms like O-Licence, CMR, DVSA, tachograph, Courier Exchange in English in brackets after the Hindi term.]'
    : responseMode === 'bilingual'
    ? ' [After your English response, add a short Hindi summary section marked with ğŸ‡®ğŸ‡³]'
    : '';

  if (apiKey) {
    // LIVE API CALL
    try {
      const messages = conversationHistory.map((m, i) => {
        if (i === conversationHistory.length - 1 && m.role === 'user') {
          return { role: 'user', content: m.content + modeInstr };
        }
        return m;
      });

      const response = await fetch('https://api.anthropic.com/v1/messages', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'x-api-key': apiKey,
          'anthropic-version': '2023-06-01',
          'anthropic-dangerous-direct-browser-access': 'true'
        },
        body: JSON.stringify({
          model: 'claude-sonnet-4-20250514',
          max_tokens: 1200,
          system: SYSTEM_PROMPT,
          messages: messages
        })
      });

      if (!response.ok) {
        const err = await response.json();
        throw new Error(err.error?.message || 'API error ' + response.status);
      }

      const data = await response.json();
      const reply = data.content?.[0]?.text || 'Sorry, I could not generate a response.';

      hideTyping();
      addMessage('assistant', reply);
      conversationHistory.push({ role: 'assistant', content: reply });
      if (voiceEnabled) speakText(reply);

    } catch (err) {
      hideTyping();
      const errMsg = err.message.includes('401') || err.message.includes('invalid')
        ? 'ğŸ”‘ **API key issue** â€” Please check your key in the sidebar and try again. Make sure it starts with `sk-ant-api03-`.'
        : 'âš ï¸ **Connection issue:** ' + err.message + '\n\nUsing built-in response instead:\n\n' + getFallback(text);
      addMessage('assistant', errMsg);
      conversationHistory.push({ role: 'assistant', content: errMsg });
    }
  } else {
    // FALLBACK â€” no API key
    await new Promise(r => setTimeout(r, 800 + Math.random() * 600));
    hideTyping();
    const reply = getFallback(text);
    addMessage('assistant', reply);
    conversationHistory.push({ role: 'assistant', content: reply });
    if (voiceEnabled) speakText(reply);
  }

  document.getElementById('send_btn').disabled = false;

  // Show quick replies again after response
  const qr = document.getElementById('quick_replies');
  if (qr) qr.style.display = 'flex';

  // Trim history to avoid token overflow (keep last 20 messages)
  if (conversationHistory.length > 20) {
    conversationHistory = conversationHistory.slice(-20);
  }
}

function clearChat() {
  conversationHistory = [];
  const msgs = document.getElementById('chat_messages');
  msgs.innerHTML = `<div class="welcome-card" id="welcome_card">
    <div class="welcome-icon">ğŸ“</div>
    <h2 style="font-family:var(--font-head);font-size:24px;font-weight:900;margin-bottom:8px">Chat cleared! Start fresh.</h2>
    <p style="font-size:14px;color:rgba(255,255,255,0.5);line-height:1.8">Pick a topic from the sidebar or type your question below.</p>
  </div>`;
  const qr = document.getElementById('quick_replies');
  if (qr) qr.style.display = 'flex';
  if (synth) synth.cancel();
}

// â”€â”€ INIT â”€â”€
window.addEventListener('DOMContentLoaded', () => {
  loadKey();
  if (synth) synth.onvoiceschanged = () => synth.getVoices();
  // Auto-focus input on desktop
  if (window.innerWidth > 768) document.getElementById('chat_input').focus();
});
</script>
</body>
</html>
